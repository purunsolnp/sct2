<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SCT ê´€ë¦¬ ëŒ€ì‹œë³´ë“œ</title>
    <!-- jsPDF ë¼ì´ë¸ŒëŸ¬ë¦¬ ì¶”ê°€ -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <!-- html2canvas ë¼ì´ë¸ŒëŸ¬ë¦¬ ì¶”ê°€ (í•œê¸€ ì§€ì›ìš©) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        /* ê¸°ì¡´ CSS ìœ ì§€ */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
            color: #333;
            background: #f5f7fa;
        }
        
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px 0;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .header-content {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .header h1 {
            font-size: 1.8em;
            font-weight: 600;
        }
        
        .user-info {
            font-size: 0.9em;
            opacity: 0.9;
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .logout-btn {
            background: rgba(255,255,255,0.2);
            color: white;
            border: 1px solid rgba(255,255,255,0.3);
            padding: 8px 15px;
            border-radius: 6px;
            font-size: 0.85em;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .logout-btn:hover {
            background: rgba(255,255,255,0.3);
            transform: translateY(-1px);
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 30px 20px;
        }
        
        .card {
            background: white;
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.08);
            margin-bottom: 25px;
        }
        
        .card h2 {
            color: #2d3748;
            margin-bottom: 20px;
            font-size: 1.5em;
            font-weight: 600;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: #4a5568;
        }
        
        .form-input {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 1em;
            transition: all 0.3s ease;
        }
        
        .form-input:focus {
            border-color: #4299e1;
            outline: none;
            box-shadow: 0 0 0 3px rgba(66, 153, 225, 0.1);
        }
        
        .button {
            background: linear-gradient(135deg, #4299e1, #667eea);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 8px;
            font-size: 1em;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 600;
        }
        
        .button:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(66, 153, 225, 0.3);
        }
        
        .button:disabled {
            background: #cbd5e0;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        
        .button-secondary {
            background: #e2e8f0;
            color: #4a5568;
            border: 2px solid #cbd5e0;
        }
        
        .button-secondary:hover {
            background: #cbd5e0;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        
        .sessions-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        
        .sessions-table th,
        .sessions-table td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid #e2e8f0;
        }
        
        .sessions-table th {
            background: #f7fafc;
            font-weight: 600;
            color: #4a5568;
        }
        
        .sessions-table tr:hover {
            background: #f7fafc;
        }
        
        .status-badge {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.85em;
            font-weight: 600;
            text-transform: uppercase;
        }
        
        .status-incomplete {
            background: #fed7d7;
            color: #c53030;
        }
        
        .status-complete {
            background: #c6f6d5;
            color: #22543d;
        }
        
        .status-expired {
            background: #e2e8f0;
            color: #718096;
        }
        
        .action-buttons {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }
        
        .action-button {
            padding: 6px 12px;
            font-size: 0.85em;
            border-radius: 6px;
            text-decoration: none;
            color: white;
            transition: all 0.2s ease;
            cursor: pointer;
            border: none;
        }
        
        .action-button.view {
            background: #4299e1;
        }
        
        .action-button.interpret {
            background: #38a169;
        }
        
        .action-button.analysis {
            background: #805ad5;
        }
        
        .action-button.copy {
            background: #ed8936;
        }
        
        .action-button:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }
        
        .link-display {
            background: #f7fafc;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            padding: 15px;
            margin-top: 15px;
            display: none;
        }
        
        .link-text {
            font-family: monospace;
            background: white;
            padding: 10px;
            border-radius: 4px;
            border: 1px solid #cbd5e0;
            word-break: break-all;
            margin-bottom: 10px;
        }
        
        .alert {
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
        }
        
        .alert-success {
            background: #c6f6d5;
            color: #22543d;
            border: 1px solid #9ae6b4;
        }
        
        .alert-error {
            background: #fed7d7;
            color: #c53030;
            border: 1px solid #feb2b2;
        }
        
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }
        
        .modal-content {
            background-color: white;
            margin: 2% auto;
            padding: 30px;
            border-radius: 12px;
            width: 90%;
            max-width: 1000px;
            max-height: 90vh;
            overflow-y: auto;
        }
        
        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }
        
        .close:hover {
            color: #333;
        }
        
        .interpretation-content {
            white-space: pre-wrap;
            line-height: 1.8;
            font-size: 1em;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        .interpretation-content h1,
        .interpretation-content h2,
        .interpretation-content h3 {
            color: #2d3748;
            margin: 20px 0 10px 0;
        }
        
        .interpretation-content h1 {
            font-size: 1.8em;
            border-bottom: 2px solid #4299e1;
            padding-bottom: 10px;
        }
        
        .interpretation-content h2 {
            font-size: 1.4em;
            color: #4299e1;
        }
        
        .interpretation-content h3 {
            font-size: 1.2em;
            color: #667eea;
        }
        
        .interpretation-content strong {
            color: #2d3748;
        }
        
        .loading {
            text-align: center;
            padding: 40px 20px;
            color: #718096;
        }
        
        .loading-spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #4299e1;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.08);
            text-align: center;
        }
        
        .stat-number {
            font-size: 2.5em;
            font-weight: bold;
            color: #4299e1;
            margin-bottom: 5px;
        }
        
        .stat-label {
            color: #718096;
            font-size: 0.9em;
            text-transform: uppercase;
            font-weight: 600;
        }
        
        .modal-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            border-bottom: 2px solid #e2e8f0;
        }
        
        .modal-tab {
            padding: 10px 20px;
            background: none;
            border: none;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            font-weight: 600;
            color: #718096;
            transition: all 0.3s ease;
        }
        
        .modal-tab.active {
            color: #4299e1;
            border-bottom-color: #4299e1;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .category-section {
            margin-bottom: 30px;
            padding: 20px;
            background: #f7fafc;
            border-radius: 8px;
            border-left: 4px solid #4299e1;
        }
        
        .category-title {
            font-weight: bold;
            color: #2d3748;
            margin-bottom: 15px;
            font-size: 1.1em;
        }
        
        .response-item {
            margin-bottom: 10px;
            padding: 10px;
            background: white;
            border-radius: 6px;
            border: 1px solid #e2e8f0;
        }
        
        .response-stem {
            font-weight: 500;
            color: #4a5568;
            margin-bottom: 5px;
        }
        
        .response-answer {
            color: #2d3748;
            font-style: italic;
        }
        
        .download-button {
            background: linear-gradient(135deg, #38a169, #48bb78);
            margin-left: 10px;
        }
        
        .download-button:hover {
            box-shadow: 0 8px 25px rgba(56, 161, 105, 0.3);
        }

        .pdf-button {
            background: linear-gradient(135deg, #e53e3e, #fc8181);
        }
        
        .pdf-button:hover {
            box-shadow: 0 8px 25px rgba(229, 62, 62, 0.3);
        }
        
        /* ë””ë²„ê·¸ ì •ë³´ ìŠ¤íƒ€ì¼ */
        .debug-info {
            background: #f0f0f0;
            border: 1px solid #ccc;
            border-radius: 4px;
            padding: 10px;
            margin: 10px 0;
            font-family: monospace;
            font-size: 0.8em;
            max-height: 200px;
            overflow-y: auto;
            display: none;
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="header-content">
            <h1>ğŸ¥ SCT ê²€ì‚¬ ê´€ë¦¬ ì‹œìŠ¤í…œ</h1>
            <div class="user-info">
                <div>
                    <strong>ì˜ì‚¬:</strong> <span id="doctor-name">ë¡œë”©ì¤‘...</span><br>
                    <small>ID: <span id="doctor-id">ë¡œë”©ì¤‘...</span></small>
                </div>
                <button onclick="logout()" class="logout-btn">ğŸšª ë¡œê·¸ì•„ì›ƒ</button>
            </div>
        </div>
    </div>
    
    <div class="container">
        <!-- ë””ë²„ê·¸ ì •ë³´ (ê°œë°œìš©) -->
        <div id="debug-info" class="debug-info">
            <strong>ë””ë²„ê·¸ ì •ë³´:</strong><br>
            <div id="debug-content"></div>
        </div>
        <button onclick="toggleDebug()" class="button-secondary" style="margin-bottom: 20px;">ğŸ› ë””ë²„ê·¸ ì •ë³´ í† ê¸€</button>
        
        <!-- í†µê³„ ì¹´ë“œ -->
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-number" id="total-sessions">0</div>
                <div class="stat-label">ì´ ì„¸ì…˜</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="completed-sessions">0</div>
                <div class="stat-label">ì™„ë£Œëœ ê²€ì‚¬</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="pending-sessions">0</div>
                <div class="stat-label">ëŒ€ê¸° ì¤‘</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="expired-sessions">0</div>
                <div class="stat-label">ë§Œë£Œë¨</div>
            </div>
        </div>
        
        <!-- ìƒˆ ê²€ì‚¬ ìƒì„± -->
        <div class="card">
            <h2>ğŸ†• ìƒˆ SCT ê²€ì‚¬ ìƒì„±</h2>
            <form id="create-session-form">
                <div class="form-group">
                    <label for="patient-name">í™˜ì ì´ë¦„</label>
                    <input type="text" id="patient-name" class="form-input" placeholder="í™˜ì ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”" required>
                </div>
                <button type="submit" class="button">ê²€ì‚¬ ì„¸ì…˜ ìƒì„±</button>
            </form>
            
            <div id="new-session-alert" class="alert alert-success" style="display: none;">
                <strong>âœ… ìƒˆ ê²€ì‚¬ê°€ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤!</strong>
                <div class="link-display" style="display: block;">
                    <p><strong>í™˜ìì—ê²Œ ì „ë‹¬í•  ê²€ì‚¬ ë§í¬:</strong></p>
                    <div class="link-text" id="patient-link"></div>
                    <div style="display: flex; gap: 10px;">
                        <button onclick="copyLink()" class="button button-secondary">ğŸ“‹ ë§í¬ ë³µì‚¬</button>
                        <button onclick="sendKakaoLink()" class="button">ğŸ’¬ ì¹´ì¹´ì˜¤í†¡ ì „ì†¡</button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- ê²€ì‚¬ ëª©ë¡ -->
        <div class="card">
            <h2>ğŸ“‹ ê²€ì‚¬ ì„¸ì…˜ ëª©ë¡</h2>
            <button onclick="refreshSessions()" class="button button-secondary">ğŸ”„ ìƒˆë¡œê³ ì¹¨</button>
            
            <div id="sessions-loading" class="loading" style="display: none;">
                ê²€ì‚¬ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...
            </div>
            
            <table class="sessions-table" id="sessions-table" style="display: none;">
                <thead>
                    <tr>
                        <th>í™˜ìëª…</th>
                        <th>ìƒì„±ì¼</th>
                        <th>ì œì¶œì¼</th>
                        <th>ë§Œë£Œì¼</th>
                        <th>ìƒíƒœ</th>
                        <th>ì‘ì—…</th>
                    </tr>
                </thead>
                <tbody id="sessions-tbody">
                </tbody>
            </table>
            
            <div id="no-sessions" style="display: none; text-align: center; color: #718096; padding: 40px;">
                ì•„ì§ ìƒì„±ëœ ê²€ì‚¬ ì„¸ì…˜ì´ ì—†ìŠµë‹ˆë‹¤.
            </div>
        </div>
    </div>
    
    <!-- í•´ì„ ê²°ê³¼ ëª¨ë‹¬ -->
    <div id="interpretation-modal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeInterpretationModal()">&times;</span>
            <h2>ğŸ“Š SCT ê²€ì‚¬ ê²°ê³¼ ë¶„ì„</h2>
            
            <div class="modal-tabs">
                <button class="modal-tab active" onclick="switchTab('interpretation')">ğŸ“‹ ì„ìƒ í•´ì„</button>
                <button class="modal-tab" onclick="switchTab('analysis')">ğŸ“ˆ ì¹´í…Œê³ ë¦¬ ë¶„ì„</button>
                <button class="modal-tab" onclick="switchTab('responses')">ğŸ“ ì „ì²´ ì‘ë‹µ</button>
            </div>
            
            <!-- í•´ì„ íƒ­ -->
            <div id="interpretation-tab" class="tab-content active">
                <div id="interpretation-loading" class="loading" style="display: none;">
                    <div class="loading-spinner"></div>
                    <p><strong>ì „ë¬¸ì ì¸ ì„ìƒ í•´ì„ì„ ìƒì„±í•˜ëŠ” ì¤‘ì…ë‹ˆë‹¤...</strong></p>
                    <p>ìˆ™ë ¨ëœ ì •ì‹ ê³¼ ì˜ì‚¬ ìˆ˜ì¤€ì˜ ë¶„ì„ì„ ìœ„í•´ ìµœëŒ€ 60ì´ˆê°€ ì†Œìš”ë  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
                </div>
                <div id="interpretation-content" class="interpretation-content"></div>
                <div id="interpretation-actions" style="display: none; margin-top: 20px; text-align: center;">
                    <button onclick="downloadInterpretationPDF()" class="button pdf-button">ğŸ“„ PDF ë³´ê³ ì„œ ë‹¤ìš´ë¡œë“œ</button>
                    <button onclick="downloadInterpretation()" class="button button-secondary" style="margin-left: 10px;">ğŸ“ í…ìŠ¤íŠ¸ ë‹¤ìš´ë¡œë“œ</button>
                </div>
            </div>
            
            <!-- ì¹´í…Œê³ ë¦¬ ë¶„ì„ íƒ­ -->
            <div id="analysis-tab" class="tab-content">
                <div id="analysis-loading" class="loading" style="display: none;">
                    <div class="loading-spinner"></div>
                    <p>ì¹´í…Œê³ ë¦¬ë³„ ë¶„ì„ì„ ì¤€ë¹„í•˜ëŠ” ì¤‘...</p>
                </div>
                <div id="analysis-content"></div>
            </div>
            
            <!-- ì „ì²´ ì‘ë‹µ íƒ­ -->
            <div id="responses-tab" class="tab-content">
                <div id="responses-content"></div>
            </div>
        </div>
    </div>

    <script>
        // ì „ì—­ ë³€ìˆ˜
        const API_BASE = window.location.hostname === 'localhost' 
            ? 'http://localhost:8000' 
            : 'https://sct-backend-7epf.onrender.com';
        let doctorId = '';
        let doctorName = '';
        let sessions = [];
        let currentSessionLink = '';
        let currentSessionId = '';
        let currentInterpretation = '';
        let debugMode = false;
        
        // ë””ë²„ê·¸ í•¨ìˆ˜
        function debugLog(message, data = null) {
            const timestamp = new Date().toLocaleTimeString();
            const logMessage = `[${timestamp}] ${message}`;
            console.log(logMessage, data || '');
            
            if (debugMode) {
                const debugContent = document.getElementById('debug-content');
                const logEntry = document.createElement('div');
                logEntry.innerHTML = `${logMessage}${data ? ': ' + JSON.stringify(data, null, 2) : ''}`;
                debugContent.appendChild(logEntry);
                debugContent.scrollTop = debugContent.scrollHeight;
            }
        }
        
        function toggleDebug() {
            debugMode = !debugMode;
            const debugInfo = document.getElementById('debug-info');
            debugInfo.style.display = debugMode ? 'block' : 'none';
            
            if (debugMode) {
                document.getElementById('debug-content').innerHTML = '';
                debugLog('ë””ë²„ê·¸ ëª¨ë“œ í™œì„±í™”');
                debugLog('í˜„ì¬ API_BASE', API_BASE);
                debugLog('í˜„ì¬ doctorId', doctorId);
                debugLog('í˜„ì¬ sessions ìˆ˜', sessions.length);
            }
        }
        
        // API í—¤ë” (JWT í† í° í¬í•¨)
        function getApiHeaders() {
            const token = localStorage.getItem('access_token');
            return {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${token}`
            };
        }
        
        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì‹¤í–‰
        document.addEventListener('DOMContentLoaded', function() {
            debugLog('í˜ì´ì§€ ë¡œë“œ ì‹œì‘');
            
            // ë¡œê·¸ì¸ í™•ì¸
            const currentUser = localStorage.getItem('currentUser');
            if (!currentUser) {
                alert('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.');
                window.location.href = 'login.html';
                return;
            }
            
            // ì‚¬ìš©ì ì •ë³´ ì„¤ì •
            const userData = JSON.parse(currentUser);
            doctorId = userData.doctorId;
            doctorName = userData.name;
            
            debugLog('ì‚¬ìš©ì ì •ë³´ ë¡œë“œ', { doctorId, doctorName });
            
            document.getElementById('doctor-id').textContent = doctorId;
            document.getElementById('doctor-name').textContent = doctorName;
            
            loadSessions();
            
            // í¼ ì œì¶œ ì´ë²¤íŠ¸
            document.getElementById('create-session-form').addEventListener('submit', createSession);
        });
        
        // ë¡œê·¸ì•„ì›ƒ
        function logout() {
            if (confirm('ì •ë§ ë¡œê·¸ì•„ì›ƒ í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                localStorage.removeItem('currentUser');
                localStorage.removeItem('access_token');
                window.location.href = 'login.html';
            }
        }
        
        // ìƒˆ ì„¸ì…˜ ìƒì„± (ìˆ˜ì •ëœ ë²„ì „)
        async function createSession(event) {
            event.preventDefault();
            
            const patientName = document.getElementById('patient-name').value.trim();
            if (!patientName) {
                alert('í™˜ì ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return;
            }
            
            debugLog('ìƒˆ ì„¸ì…˜ ìƒì„± ì‹œì‘', { patientName, doctorId });
            
            try {
                const requestBody = {
                    patient_name: patientName,
                    assigned_by: doctorId
                };
                
                debugLog('ì „ì†¡í•  ë°ì´í„°', requestBody);
                
                const response = await fetch(`${API_BASE}/sct/sessions`, {
                    method: 'POST',
                    headers: getApiHeaders(),
                    body: JSON.stringify(requestBody)
                });
                
                debugLog('ì„¸ì…˜ ìƒì„± ì‘ë‹µ ìƒíƒœ', response.status);
                
                if (!response.ok) {
                    if (response.status === 401) {
                        alert('ë¡œê·¸ì¸ì´ ë§Œë£Œë˜ì—ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ë¡œê·¸ì¸í•´ì£¼ì„¸ìš”.');
                        localStorage.removeItem('access_token');
                        localStorage.removeItem('currentUser');
                        window.location.href = 'login.html';
                        return;
                    }
                    const errorData = await response.json();
                    debugLog('ì„¸ì…˜ ìƒì„± ì˜¤ë¥˜', errorData);
                    throw new Error(errorData.detail || 'ì„¸ì…˜ ìƒì„±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                }
                
                const sessionData = await response.json();
                debugLog('ìƒì„±ëœ ì„¸ì…˜', sessionData);
                
                // ì„±ê³µ ë©”ì‹œì§€ ë° ë§í¬ í‘œì‹œ
                const patientLink = `${window.location.origin}/patient.html?session=${sessionData.session_id}`;
                currentSessionLink = patientLink;
                
                document.getElementById('patient-link').textContent = patientLink;
                document.getElementById('new-session-alert').style.display = 'block';
                
                // í¼ ì´ˆê¸°í™”
                document.getElementById('patient-name').value = '';
                
                // ì„¸ì…˜ ëª©ë¡ ìƒˆë¡œê³ ì¹¨
                await loadSessions();
                
            } catch (error) {
                debugLog('ì„¸ì…˜ ìƒì„± ì˜¤ë¥˜', error.message);
                alert('ì„¸ì…˜ ìƒì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
            }
        }
        
        // ì„¸ì…˜ ëª©ë¡ ë¡œë“œ (ìˆ˜ì •ëœ ë²„ì „)
        async function loadSessions() {
            debugLog('ì„¸ì…˜ ëª©ë¡ ë¡œë“œ ì‹œì‘');
            document.getElementById('sessions-loading').style.display = 'block';
            document.getElementById('sessions-table').style.display = 'none';
            document.getElementById('no-sessions').style.display = 'none';
            
            try {
                const url = `${API_BASE}/sct/sessions/by-user/${doctorId}`;
                debugLog('API ìš”ì²­ URL', url);
                
                const response = await fetch(url, {
                    headers: getApiHeaders()
                });
                
                debugLog('API ì‘ë‹µ ìƒíƒœ', response.status);
                
                if (!response.ok) {
                    if (response.status === 401) {
                        alert('ë¡œê·¸ì¸ì´ ë§Œë£Œë˜ì—ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ë¡œê·¸ì¸í•´ì£¼ì„¸ìš”.');
                        localStorage.removeItem('access_token');
                        localStorage.removeItem('currentUser');
                        window.location.href = 'login.html';
                        return;
                    }
                    const errorText = await response.text();
                    debugLog('API ì‘ë‹µ ì˜¤ë¥˜', errorText);
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                debugLog('ë°›ì€ ë°ì´í„°', data);
                
                // ë°ì´í„° êµ¬ì¡° í™•ì¸ ë° ì •ê·œí™”
                sessions = Array.isArray(data) ? data : (data.sessions || []);
                debugLog('ì²˜ë¦¬ëœ ì„¸ì…˜ ë°ì´í„°', sessions);
                
                updateStats();
                renderSessionsTable();
                
            } catch (error) {
                debugLog('ì„¸ì…˜ ë¡œë“œ ì˜¤ë¥˜', error.message);
                alert('ì„¸ì…˜ ëª©ë¡ ë¡œë“œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
                
                // ì˜¤ë¥˜ ë°œìƒ ì‹œ ë¹ˆ ë°°ì—´ë¡œ ì´ˆê¸°í™”
                sessions = [];
                updateStats();
                renderSessionsTable();
            } finally {
                document.getElementById('sessions-loading').style.display = 'none';
            }
        }
        
        // í†µê³„ ì—…ë°ì´íŠ¸ (ìˆ˜ì •ëœ ë²„ì „)
        function updateStats() {
            debugLog('í†µê³„ ì—…ë°ì´íŠ¸', sessions);
            
            const total = sessions ? sessions.length : 0;
            const completed = sessions ? sessions.filter(s => s.status === 'complete').length : 0;
            const pending = sessions ? sessions.filter(s => s.status === 'incomplete').length : 0;
            const expired = sessions ? sessions.filter(s => s.status === 'expired').length : 0;
            
            debugLog('í†µê³„ ê²°ê³¼', { total, completed, pending, expired });
            
            document.getElementById('total-sessions').textContent = total;
            document.getElementById('completed-sessions').textContent = completed;
            document.getElementById('pending-sessions').textContent = pending;
            document.getElementById('expired-sessions').textContent = expired;
        }
        
        // ì„¸ì…˜ í…Œì´ë¸” ë Œë”ë§ (ìˆ˜ì •ëœ ë²„ì „)
        function renderSessionsTable() {
            debugLog('í…Œì´ë¸” ë Œë”ë§ ì‹œì‘', `ì„¸ì…˜ ìˆ˜: ${sessions.length}`);
            const tbody = document.getElementById('sessions-tbody');
            tbody.innerHTML = '';
            
            if (!sessions || sessions.length === 0) {
                document.getElementById('no-sessions').style.display = 'block';
                document.getElementById('sessions-table').style.display = 'none';
                debugLog('ì„¸ì…˜ì´ ì—†ìŒ');
                return;
            }
            
            document.getElementById('sessions-table').style.display = 'table';
            document.getElementById('no-sessions').style.display = 'none';
            
            sessions.forEach((session, index) => {
                debugLog(`ì„¸ì…˜ ${index + 1} ì²˜ë¦¬`, session);
                
                const row = document.createElement('tr');
                
                // ì•ˆì „í•œ ë°ì´í„° ì¶”ì¶œ
                let patientName = 'UNKNOWN';
                console.log('ğŸ” ì„¸ì…˜ ë°ì´í„° ë¶„ì„:', session);
                console.log('ğŸ” patient_name ì§ì ‘ ì ‘ê·¼:', session.patient_name);
                console.log('ğŸ” patient_name íƒ€ì…:', typeof session.patient_name);
                console.log('ğŸ” patient_name ê¸¸ì´:', session.patient_name ? session.patient_name.length : 'null/undefined');

                if (session.patient_name && session.patient_name.trim() !== '') {
                    patientName = session.patient_name.trim();
                    console.log('âœ… patient_name ì •ìƒ:', patientName);
                } else if (session.patientName && session.patientName.trim() !== '') {
                    patientName = session.patientName.trim();
                    console.log('âœ… patientName(camelCase) ì‚¬ìš©:', patientName);
                } else {
                    console.warn('âŒ í™˜ì ì´ë¦„ì„ ì°¾ì„ ìˆ˜ ì—†ìŒ, ì„¸ì…˜ ì „ì²´:', session);
                    patientName = 'NO_NAME_FOUND';
}
                const sessionId = session.session_id || session.sessionId || 'Unknown';
                const status = session.status || 'unknown';
                
                // ë‚ ì§œ í¬ë§·íŒ… (ë” ì•ˆì „í•œ ë°©ì‹)
                const createdAt = formatDate(session.created_at || session.createdAt);
                const submittedAt = formatDate(session.submitted_at || session.submittedAt);
                const expiresAt = formatDate(session.expires_at || session.expiresAt);
                
                debugLog(`ë‚ ì§œ í¬ë§·íŒ… ê²°ê³¼`, { createdAt, submittedAt, expiresAt });
                
                // ìƒíƒœ ë±ƒì§€
                const { statusClass, statusText } = getStatusInfo(status);
                
                // ì‘ì—… ë²„íŠ¼ë“¤
                const actionButtons = generateActionButtons(session, sessionId);
                
                row.innerHTML = `
                    <td>${patientName}</td>
                    <td>${createdAt}</td>
                    <td>${submittedAt}</td>
                    <td>${expiresAt}</td>
                    <td><span class="status-badge ${statusClass}">${statusText}</span></td>
                    <td>
                        <div class="action-buttons">
                            ${actionButtons}
                        </div>
                    </td>
                `;
                
                tbody.appendChild(row);
            });
            
            debugLog('í…Œì´ë¸” ë Œë”ë§ ì™„ë£Œ');
        }
        
        // ì•ˆì „í•œ ë‚ ì§œ í¬ë§·íŒ… í•¨ìˆ˜
        function formatDate(dateString) {
            if (!dateString) {
                return '-';
            }
            
            try {
                // ISO ë‚ ì§œ ë¬¸ìì—´ ì •ê·œí™”
                let normalizedDate = dateString;
                
                // Zë¡œ ëë‚˜ëŠ” ê²½ìš° UTCë¡œ ì²˜ë¦¬
                if (dateString.endsWith('Z')) {
                    normalizedDate = dateString;
                }
                // +00:00 í˜•íƒœì¸ ê²½ìš° Zë¡œ ë³€í™˜
                else if (dateString.includes('+00:00')) {
                    normalizedDate = dateString.replace('+00:00', 'Z');
                }
                // Tê°€ ì—†ëŠ” ê²½ìš° ì¶”ê°€
                else if (!dateString.includes('T') && dateString.includes(' ')) {
                    normalizedDate = dateString.replace(' ', 'T') + 'Z';
                }
                
                const date = new Date(normalizedDate);
                
                // ìœ íš¨í•œ ë‚ ì§œì¸ì§€ í™•ì¸
                if (isNaN(date.getTime())) {
                    debugLog('ì˜ëª»ëœ ë‚ ì§œ í˜•ì‹', dateString);
                    return 'Invalid Date';
                }
                
                // í•œêµ­ ì‹œê°„ìœ¼ë¡œ ë³€í™˜í•˜ì—¬ í‘œì‹œ
                return date.toLocaleDateString('ko-KR', {
                    year: 'numeric',
                    month: '2-digit',
                    day: '2-digit',
                    hour: '2-digit',
                    minute: '2-digit'
                });
                
            } catch (error) {
                debugLog('ë‚ ì§œ í¬ë§·íŒ… ì˜¤ë¥˜', { error: error.message, original: dateString });
                return 'Format Error';
            }
        }
        
        // ìƒíƒœ ì •ë³´ ë°˜í™˜
        function getStatusInfo(status) {
            let statusClass = '';
            let statusText = '';
            
            switch (status) {
                case 'incomplete':
                    statusClass = 'status-incomplete';
                    statusText = 'ëŒ€ê¸°ì¤‘';
                    break;
                case 'complete':
                    statusClass = 'status-complete';
                    statusText = 'ì™„ë£Œ';
                    break;
                case 'expired':
                    statusClass = 'status-expired';
                    statusText = 'ë§Œë£Œ';
                    break;
                default:
                    statusClass = 'status-incomplete';
                    statusText = 'ì•Œ ìˆ˜ ì—†ìŒ';
            }
            
            return { statusClass, statusText };
        }
        
        // ì‘ì—… ë²„íŠ¼ ìƒì„±
        function generateActionButtons(session, sessionId) {
            const status = session.status || 'incomplete';
            let actionButtons = '';
            
            if (status === 'incomplete') {
                const patientLink = `${window.location.origin}/patient.html?session=${sessionId}`;
                actionButtons = `
                    <button onclick="copySessionLink('${patientLink}')" class="action-button copy">ë§í¬ ë³µì‚¬</button>
                `;
            } else if (status === 'complete') {
                actionButtons = `
                    <button onclick="openAnalysisModal('${sessionId}')" class="action-button interpret">ğŸ“Š ì „ë¬¸ í•´ì„</button>
                `;
            }
            
            return actionButtons;
        }
        
        // ë§í¬ ë³µì‚¬
        function copyLink() {
            navigator.clipboard.writeText(currentSessionLink).then(() => {
                alert('ë§í¬ê°€ í´ë¦½ë³´ë“œì— ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤!');
            });
        }
        
        // ì„¸ì…˜ ë§í¬ ë³µì‚¬
        function copySessionLink(link) {
            navigator.clipboard.writeText(link).then(() => {
                alert('ê²€ì‚¬ ë§í¬ê°€ í´ë¦½ë³´ë“œì— ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤!');
            });
        }
        
        // ì¹´ì¹´ì˜¤í†¡ ì „ì†¡
        function sendKakaoLink() {
            alert('ì¹´ì¹´ì˜¤í†¡ ì „ì†¡ ê¸°ëŠ¥ì€ ì¶”í›„ êµ¬í˜„ ì˜ˆì •ì…ë‹ˆë‹¤.\ní˜„ì¬ëŠ” ë§í¬ë¥¼ ë³µì‚¬í•´ì„œ ì§ì ‘ ì „ì†¡í•´ì£¼ì„¸ìš”.');
        }
        
        // ì„¸ì…˜ ëª©ë¡ ìƒˆë¡œê³ ì¹¨
        function refreshSessions() {
            debugLog('ì„¸ì…˜ ëª©ë¡ ìƒˆë¡œê³ ì¹¨ ìš”ì²­');
            loadSessions();
        }
        
        // ë¶„ì„ ëª¨ë‹¬ ì—´ê¸°
        async function openAnalysisModal(sessionId) {
            debugLog('ë¶„ì„ ëª¨ë‹¬ ì—´ê¸°', sessionId);
            currentSessionId = sessionId;
            const modal = document.getElementById('interpretation-modal');
            modal.style.display = 'block';
            
            // ì²« ë²ˆì§¸ íƒ­ í™œì„±í™”
            switchTab('interpretation');
            
            // í•´ì„ ìë™ ìƒì„±
            await generateInterpretation(sessionId);
        }
        
        // íƒ­ ì „í™˜
        function switchTab(tabName) {
            debugLog('íƒ­ ì „í™˜', tabName);
            
            // ëª¨ë“  íƒ­ ë¹„í™œì„±í™”
            document.querySelectorAll('.modal-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            
            // ì„ íƒëœ íƒ­ í™œì„±í™”
            document.querySelector(`[onclick="switchTab('${tabName}')"]`).classList.add('active');
            document.getElementById(`${tabName}-tab`).classList.add('active');
            
            // íƒ­ë³„ ë°ì´í„° ë¡œë“œ
            if (tabName === 'analysis' && currentSessionId) {
                loadCategoricalAnalysis(currentSessionId);
            } else if (tabName === 'responses' && currentSessionId) {
                loadAllResponses(currentSessionId);
            }
        }
        
        // ì „ë¬¸ í•´ì„ ìƒì„± (ì‹¤ì œ API í˜¸ì¶œ)
        async function generateInterpretation(sessionId) {
            debugLog('ì „ë¬¸ í•´ì„ ìƒì„± ì‹œì‘', sessionId);
            
            const loading = document.getElementById('interpretation-loading');
            const content = document.getElementById('interpretation-content');
            const actions = document.getElementById('interpretation-actions');
            
            loading.style.display = 'block';
            content.innerHTML = '';
            actions.style.display = 'none';
            
            try {
                // ë¨¼ì € ê¸°ì¡´ í•´ì„ì´ ìˆëŠ”ì§€ í™•ì¸
                let interpretationResponse = await fetch(`${API_BASE}/sct/sessions/${sessionId}/interpretation`, {
                    headers: getApiHeaders()
                });
                
                debugLog('í•´ì„ ì¡°íšŒ ì‘ë‹µ', interpretationResponse.status);
                
                if (interpretationResponse.status === 404) {
                    debugLog('í•´ì„ì´ ì—†ìŒ, ìƒˆë¡œ ìƒì„±');
                    // í•´ì„ì´ ì—†ìœ¼ë©´ ìƒˆë¡œ ìƒì„±
                    const generateResponse = await fetch(`${API_BASE}/sct/sessions/${sessionId}/interpret`, {
                        method: 'POST',
                        headers: getApiHeaders()
                    });
                    
                    debugLog('í•´ì„ ìƒì„± ì‘ë‹µ', generateResponse.status);
                    
                    if (!generateResponse.ok) {
                        const errorData = await generateResponse.json();
                        throw new Error(errorData.detail || 'í•´ì„ ìƒì„±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                    }
                    
                    // ìƒì„±ëœ í•´ì„ ê°€ì ¸ì˜¤ê¸°
                    interpretationResponse = await fetch(`${API_BASE}/sct/sessions/${sessionId}/interpretation`, {
                        headers: getApiHeaders()
                    });
                }
                
                if (!interpretationResponse.ok) {
                    if (interpretationResponse.status === 401) {
                        alert('ë¡œê·¸ì¸ì´ ë§Œë£Œë˜ì—ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ë¡œê·¸ì¸í•´ì£¼ì„¸ìš”.');
                        localStorage.removeItem('access_token');
                        localStorage.removeItem('currentUser');
                        window.location.href = 'login.html';
                        return;
                    }
                    throw new Error('í•´ì„ ê²°ê³¼ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                }
                
                const data = await interpretationResponse.json();
                debugLog('í•´ì„ ë°ì´í„° ìˆ˜ì‹ ', data);
                
                currentInterpretation = data.interpretation;
                
                loading.style.display = 'none';
                
                // ë§ˆí¬ë‹¤ìš´ ìŠ¤íƒ€ì¼ í•´ì„ ê²°ê³¼ í‘œì‹œ
                content.innerHTML = formatInterpretation(data.interpretation, data.patient_name);
                actions.style.display = 'block';
                
            } catch (error) {
                debugLog('í•´ì„ ìƒì„± ì˜¤ë¥˜', error.message);
                loading.style.display = 'none';
                content.innerHTML = `
                    <div class="alert alert-error">
                        <strong>âŒ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤</strong><br>
                        ${error.message}
                    </div>
                `;
            }
        }
        
        // í•´ì„ ê²°ê³¼ í¬ë§·íŒ…
        function formatInterpretation(interpretation, patientName) {
            let formatted = interpretation
                .replace(/^# /gm, '<h1>')
                .replace(/^## /gm, '<h2>')
                .replace(/^### /gm, '<h3>')
                .replace(/\n/g, '<br>')
                .replace(/<h([123])>([^<]*)<br>/g, '<h$1>$2</h$1>')
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                .replace(/\*(.*?)\*/g, '<em>$1</em>');
            
            return `
                <div style="margin-bottom: 20px; padding: 15px; background: #ebf8ff; border-radius: 8px; border-left: 4px solid #4299e1;">
                    <h3 style="margin: 0; color: #2b6cb0;">í™˜ì: ${patientName}</h3>
                    <p style="margin: 5px 0 0 0; color: #2c5282;">í•´ì„ ìƒì„±ì¼: ${new Date().toLocaleString('ko-KR')}</p>
                </div>
                ${formatted}
            `;
        }
        
        // ì¹´í…Œê³ ë¦¬ë³„ ë¶„ì„ ë¡œë“œ
        async function loadCategoricalAnalysis(sessionId) {
            debugLog('ì¹´í…Œê³ ë¦¬ë³„ ë¶„ì„ ë¡œë“œ', sessionId);
            
            const loading = document.getElementById('analysis-loading');
            const content = document.getElementById('analysis-content');
            
            loading.style.display = 'block';
            content.innerHTML = '';
            
            try {
                const response = await fetch(`${API_BASE}/sct/sessions/${sessionId}/analysis`);
                
                if (!response.ok) {
                    throw new Error('ì¹´í…Œê³ ë¦¬ ë¶„ì„ì„ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                }
                
                const data = await response.json();
                debugLog('ì¹´í…Œê³ ë¦¬ ë¶„ì„ ë°ì´í„°', data);
                
                loading.style.display = 'none';
                
                // ì¹´í…Œê³ ë¦¬ë³„ ì‘ë‹µ í‘œì‹œ
                let html = '';
                const categoryNames = {
                    'ê°€ì¡±ê´€ê³„': 'ğŸ‘¨â€ğŸ‘©â€ğŸ‘§â€ğŸ‘¦ ê°€ì¡± ê´€ê³„',
                    'ëŒ€ì¸ê´€ê³„': 'ğŸ¤ ëŒ€ì¸ ê´€ê³„',
                    'ìì•„ê°œë…': 'ğŸª ìì•„ ê°œë…',
                    'ì •ì„œì¡°ì ˆ': 'ğŸ’­ ì •ì„œ ì¡°ì ˆ',
                    'ì„±_ê²°í˜¼ê´€': 'ğŸ’• ì„± ë° ê²°í˜¼ê´€',
                    'ë¯¸ë˜ì „ë§': 'ğŸ”® ë¯¸ë˜ ì „ë§',
                    'ê³¼ê±°ê²½í—˜': 'ğŸ“– ê³¼ê±° ê²½í—˜',
                    'í˜„ì‹¤ì ì‘': 'ğŸŒ í˜„ì‹¤ ì ì‘',
                    'ì„±ê²©íŠ¹ì„±': 'â­ ì„±ê²© íŠ¹ì„±'
                };
                
                for (const [category, responses] of Object.entries(data.categorized_responses)) {
                    if (responses.length > 0) {
                        html += `
                            <div class="category-section">
                                <div class="category-title">${categoryNames[category] || category}</div>
                        `;
                        
                        responses.forEach(response => {
                            html += `
                                <div class="response-item">
                                    <div class="response-stem">${response.item_no}. ${response.stem}</div>
                                    <div class="response-answer">â†’ ${response.answer}</div>
                                </div>
                            `;
                        });
                        
                        html += '</div>';
                    }
                }
                
                content.innerHTML = html;
                
            } catch (error) {
                debugLog('ì¹´í…Œê³ ë¦¬ ë¶„ì„ ë¡œë“œ ì˜¤ë¥˜', error.message);
                loading.style.display = 'none';
                content.innerHTML = `
                    <div class="alert alert-error">
                        ì˜¤ë¥˜: ${error.message}
                    </div>
                `;
            }
        }
        
        // ì „ì²´ ì‘ë‹µ ë¡œë“œ
        async function loadAllResponses(sessionId) {
            debugLog('ì „ì²´ ì‘ë‹µ ë¡œë“œ', sessionId);
            
            const content = document.getElementById('responses-content');
            
            try {
                const response = await fetch(`${API_BASE}/sct/sessions/${sessionId}`);
                
                if (!response.ok) {
                    throw new Error('ì„¸ì…˜ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                }
                
                const data = await response.json();
                debugLog('ì „ì²´ ì‘ë‹µ ë°ì´í„°', data);
                
                let html = '<div style="max-height: 500px; overflow-y: auto;">';
                
                if (data.responses && data.responses.length > 0) {
                    data.responses.forEach(response => {
                        html += `
                            <div class="response-item">
                                <div class="response-stem">${response.item_no}. ${response.stem}</div>
                                <div class="response-answer">â†’ ${response.answer}</div>
                            </div>
                        `;
                    });
                } else {
                    html += '<p>ì‘ë‹µ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
                }
                
                html += '</div>';
                content.innerHTML = html;
                
            } catch (error) {
                debugLog('ì „ì²´ ì‘ë‹µ ë¡œë“œ ì˜¤ë¥˜', error.message);
                content.innerHTML = `
                    <div class="alert alert-error">
                        ì˜¤ë¥˜: ${error.message}
                    </div>
                `;
            }
        }
        
        // PDF í•´ì„ ë³´ê³ ì„œ ë‹¤ìš´ë¡œë“œ (í•œê¸€ ì§€ì› ë²„ì „)
        async function downloadInterpretationPDF() {
            if (!currentInterpretation) {
                alert('ë‹¤ìš´ë¡œë“œí•  í•´ì„ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }
            
            const sessionData = sessions.find(s => s.session_id === currentSessionId);
            const patientName = sessionData ? sessionData.patient_name : 'í™˜ì';
            const today = new Date().toISOString().split('T')[0];
            
            try {
                // ì„ì‹œ PDF ì½˜í…ì¸  ìƒì„±
                const reportContent = createPDFContent(patientName, currentInterpretation);
                
                // HTMLì„ canvasë¡œ ë³€í™˜ (í•œê¸€ ì§€ì›)
                const canvas = await html2canvas(reportContent, {
                    scale: 2,
                    useCORS: true,
                    allowTaint: true,
                    backgroundColor: '#ffffff'
                });
                
                const imgData = canvas.toDataURL('image/png');
                
                // PDF ìƒì„±
                const { jsPDF } = window.jspdf;
                const pdf = new jsPDF({
                    orientation: 'portrait',
                    unit: 'mm',
                    format: 'a4'
                });
                
                const imgWidth = 210;
                const pageHeight = 295;
                const imgHeight = (canvas.height * imgWidth) / canvas.width;
                let heightLeft = imgHeight;
                let position = 0;
                
                pdf.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
                heightLeft -= pageHeight;
                
                while (heightLeft >= 0) {
                    position = heightLeft - imgHeight;
                    pdf.addPage();
                    pdf.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
                    heightLeft -= pageHeight;
                }
                
                // ì„ì‹œ ìš”ì†Œ ì œê±°
                document.body.removeChild(reportContent);
                
                // PDF ë‹¤ìš´ë¡œë“œ
                pdf.save(`SCT_í•´ì„ë³´ê³ ì„œ_${patientName}_${today}.pdf`);
                
            } catch (error) {
                debugLog('PDF ìƒì„± ì˜¤ë¥˜', error.message);
                alert('PDF ìƒì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. í…ìŠ¤íŠ¸ ë‹¤ìš´ë¡œë“œë¥¼ ì´ìš©í•´ì£¼ì„¸ìš”.');
            }
        }
        
        // PDFìš© HTML ì½˜í…ì¸  ìƒì„±
        function createPDFContent(patientName, interpretation) {
            const div = document.createElement('div');
            div.style.cssText = `
                width: 210mm;
                min-height: 297mm;
                padding: 20mm;
                background: white;
                font-family: 'Malgun Gothic', sans-serif;
                position: absolute;
                left: -9999px;
                top: 0;
            `;
            
            // HTMLì„ í…ìŠ¤íŠ¸ë¡œ ë³€í™˜
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = interpretation;
            const textContent = tempDiv.textContent || tempDiv.innerText || '';
            
            div.innerHTML = `
                <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px; margin: -20mm -20mm 20px -20mm; text-align: center;">
                    <h1 style="font-size: 24px; margin: 0; font-weight: bold;">SCT ê²€ì‚¬ í•´ì„ ë³´ê³ ì„œ</h1>
                    <p style="font-size: 14px; margin: 10px 0 0 0;">ğŸ¥ ì „ë¬¸ ì‹¬ë¦¬ê²€ì‚¬ ì‹œìŠ¤í…œ</p>
                </div>
                
                <div style="border: 2px solid #4299e1; border-radius: 8px; padding: 15px; margin-bottom: 20px; background: #f7fafc;">
                    <h3 style="color: #2b6cb0; margin: 0 0 10px 0; font-size: 16px;">í™˜ì ì •ë³´</h3>
                    <p style="margin: 5px 0; font-size: 12px;"><strong>í™˜ìëª…:</strong> ${patientName}</p>
                    <p style="margin: 5px 0; font-size: 12px;"><strong>í•´ì„ ìƒì„±ì¼:</strong> ${new Date().toLocaleString('ko-KR')}</p>
                    <p style="margin: 5px 0; font-size: 12px;"><strong>ì„¸ì…˜ ID:</strong> ${currentSessionId}</p>
                </div>
                
                <div style="white-space: pre-wrap; line-height: 1.6; font-size: 11px;">
                    ${textContent}
                </div>
                
                <div style="margin-top: 30px; padding-top: 15px; border-top: 1px solid #ccc; font-size: 10px; color: #666;">
                    <p><strong>ë©´ì±…ì¡°í•­:</strong> ë³¸ ë³´ê³ ì„œëŠ” AI ê¸°ë°˜ ìë™ í•´ì„ ì‹œìŠ¤í…œì— ì˜í•´ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤.</p>
                    <p>ì„ìƒì  íŒë‹¨ì€ ë°˜ë“œì‹œ ì „ë¬¸ì˜ì˜ ê²€í† ë¥¼ ê±°ì³ ìµœì¢… í™•ì •ë˜ì–´ì•¼ í•©ë‹ˆë‹¤.</p>
                </div>
            `;
            
            document.body.appendChild(div);
            return div;
        }
        
        // í…ìŠ¤íŠ¸ í•´ì„ ë³´ê³ ì„œ ë‹¤ìš´ë¡œë“œ
        function downloadInterpretation() {
            if (!currentInterpretation) {
                alert('ë‹¤ìš´ë¡œë“œí•  í•´ì„ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }
            
            const sessionData = sessions.find(s => s.session_id === currentSessionId);
            const patientName = sessionData ? sessionData.patient_name : 'í™˜ì';
            const today = new Date().toISOString().split('T')[0];
            
            // HTMLì„ í…ìŠ¤íŠ¸ë¡œ ë³€í™˜
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = currentInterpretation;
            const textContent = tempDiv.textContent || tempDiv.innerText || '';
            
            const content = `SCT (ë¬¸ì¥ì™„ì„±ê²€ì‚¬) í•´ì„ ë³´ê³ ì„œ

í™˜ìëª…: ${patientName}
í•´ì„ ìƒì„±ì¼: ${new Date().toLocaleString('ko-KR')}
ì„¸ì…˜ ID: ${currentSessionId}

${textContent}

---
ë³¸ ë³´ê³ ì„œëŠ” AI ê¸°ë°˜ ìë™ í•´ì„ ì‹œìŠ¤í…œì— ì˜í•´ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤.
ì„ìƒì  íŒë‹¨ì€ ë°˜ë“œì‹œ ì „ë¬¸ì˜ì˜ ê²€í† ë¥¼ ê±°ì³ ìµœì¢… í™•ì •ë˜ì–´ì•¼ í•©ë‹ˆë‹¤.
`;
            
            const blob = new Blob([content], { type: 'text/plain;charset=utf-8' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `SCT_í•´ì„ë³´ê³ ì„œ_${patientName}_${today}.txt`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
        }
        
        // í•´ì„ ëª¨ë‹¬ ë‹«ê¸°
        function closeInterpretationModal() {
            document.getElementById('interpretation-modal').style.display = 'none';
            currentSessionId = '';
            currentInterpretation = '';
        }
        
        // ëª¨ë‹¬ ì™¸ë¶€ í´ë¦­ ì‹œ ë‹«ê¸°
        window.onclick = function(event) {
            const modal = document.getElementById('interpretation-modal');
            if (event.target === modal) {
                modal.style.display = 'none';
            }
        }
    </script>
</body>
</html>