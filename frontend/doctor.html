<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SCT ê²€ì‚¬ ê´€ë¦¬ ì‹œìŠ¤í…œ</title>
    <style>
        /* ê¸°ì¡´ ìŠ¤íƒ€ì¼ ìœ ì§€ (í•„ìš”í•œ ë¶€ë¶„ë§Œ) */
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f5f7fa;
            color: #333;
            margin: 0;
            padding: 0;
        }
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px 0;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .header-content {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .header h1 {
            font-size: 1.8em;
            font-weight: 600;
        }
        .user-info {
            font-size: 0.9em;
            opacity: 0.9;
            display: flex;
            align-items: center;
            gap: 15px;
        }
        .logout-btn {
            background: rgba(255,255,255,0.2);
            color: white;
            border: 1px solid rgba(255,255,255,0.3);
            padding: 8px 15px;
            border-radius: 6px;
            font-size: 0.85em;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        .logout-btn:hover {
            background: rgba(255,255,255,0.3);
            transform: translateY(-1px);
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 30px 20px;
        }
        .card {
            background: white;
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.08);
            margin-bottom: 25px;
        }
        .form-group {
            margin-bottom: 20px;
        }
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: #4a5568;
        }
        .form-input {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 1em;
            transition: all 0.3s ease;
        }
        .form-input:focus {
            border-color: #4299e1;
            outline: none;
            box-shadow: 0 0 0 3px rgba(66, 153, 225, 0.1);
        }
        .button {
            background: linear-gradient(135deg, #4299e1, #667eea);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 8px;
            font-size: 1em;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 600;
        }
        .button:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(66, 153, 225, 0.3);
        }
        .button-secondary {
            background: #e2e8f0;
            color: #4a5568;
            border: 2px solid #cbd5e0;
        }
        .button-secondary:hover {
            background: #cbd5e0;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.08);
            text-align: center;
        }
        .stat-number {
            font-size: 2.5em;
            font-weight: bold;
            color: #4299e1;
            margin-bottom: 5px;
        }
        .stat-label {
            color: #718096;
            font-size: 0.9em;
            text-transform: uppercase;
            font-weight: 600;
        }
        .sessions-table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
            margin-top: 20px;
            font-size: 1.05em;
            background: #fff;
            box-shadow: 0 2px 8px rgba(0,0,0,0.04);
            border-radius: 10px;
            overflow: hidden;
        }
        .sessions-table th, .sessions-table td {
            padding: 16px 18px;
            text-align: left;
            border-bottom: 1px solid #e2e8f0;
        }
        .sessions-table th {
            background: #f1f5f9;
            font-weight: 700;
            color: #2b4360;
            font-size: 1.08em;
        }
        .sessions-table tr:hover {
            background: #f7fafc;
        }
        .sessions-table tr:last-child td {
            border-bottom: none;
        }
        .action-buttons {
            gap: 10px;
        }
        .action-button {
            padding: 7px 16px;
            border-radius: 6px;
            font-size: 0.97em;
            font-weight: 500;
        }
        .modal {
            display: none;
            position: fixed;
            z-index: 1;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.4);
        }
        .modal-content {
            background-color: #fefefe;
            margin: 5% auto;
            padding: 20px;
            border: 1px solid #888;
            width: 90%;
            max-width: 900px;
            border-radius: 10px;
            max-height: 85vh;
            overflow-y: auto;
        }
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #e2e8f0;
        }
        .modal-header h2 {
            font-size: 1.5em;
            font-weight: 600;
            color: #2d3748;
        }
        .modal-actions {
            display: flex;
            gap: 10px;
        }
        .action-button {
            display: flex;
            align-items: center;
            gap: 5px;
            padding: 8px 12px;
            border: none;
            border-radius: 6px;
            background: #4299e1;
            color: white;
            cursor: pointer;
            font-size: 0.9em;
            transition: all 0.3s ease;
        }
        .action-button:hover {
            background: #3182ce;
            transform: translateY(-1px);
        }
        .action-button .icon {
            font-size: 1.1em;
        }
        .modal-body {
            padding: 20px;
        }
        .interpretation-content {
            max-height: 70vh;
            overflow-y: auto;
            padding: 20px;
            line-height: 1.8;
            font-size: 1.1em;
        }
        .response-item {
            margin-bottom: 20px;
            padding: 15px;
            background: #f7fafc;
            border-radius: 8px;
            border: 1px solid #e2e8f0;
        }
        .response-item .item-number {
            font-weight: bold;
            color: #2d3748;
            margin-bottom: 5px;
        }
        .response-item .stem {
            color: #4a5568;
            margin-bottom: 10px;
        }
        .response-item .answer {
            color: #2d3748;
            font-weight: 500;
            padding: 10px;
            background: white;
            border-radius: 6px;
            border: 1px solid #e2e8f0;
        }
        .close-button {
            background: none;
            border: none;
            font-size: 1.5em;
            font-weight: bold;
            cursor: pointer;
            color: #667eea;
        }
        .responses-content {
            max-height: 70vh;
            overflow-y: auto;
            padding: 20px;
        }
        .responses-content .response-item {
            margin-bottom: 20px;
            padding: 15px;
            background: #f7fafc;
            border-radius: 8px;
            border: 1px solid #e2e8f0;
        }
        .responses-content .response-item .item-number {
            font-weight: bold;
            color: #2d3748;
            margin-bottom: 5px;
        }
        .responses-content .response-item .stem {
            color: #4a5568;
            margin-bottom: 10px;
        }
        .responses-content .response-item .answer {
            color: #2d3748;
            font-weight: 500;
            padding: 10px;
            background: white;
            border-radius: 6px;
            border: 1px solid #e2e8f0;
        }

        /* ë³´ê³ ì„œ ìŠ¤íƒ€ì¼ ê°œì„  */
        .report-title-print {
            font-size: 2.5em;
            font-weight: bold;
            color: #2b6cb0;
            text-align: center;
            margin-bottom: 40px;
            margin-top: 0;
            letter-spacing: 2px;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.1);
        }

        .interpretation-content h1, .interpretation-content h2, .interpretation-content h3 {
            color: #2d3748;
            margin-top: 30px;
            margin-bottom: 15px;
            padding-bottom: 8px;
            border-bottom: 2px solid #e2e8f0;
        }

        .interpretation-content h1 {
            font-size: 1.8em;
            color: #2b6cb0;
        }

        .interpretation-content h2 {
            font-size: 1.5em;
            color: #3182ce;
        }

        .interpretation-content h3 {
            font-size: 1.3em;
            color: #4299e1;
        }

        .interpretation-content p {
            margin-bottom: 16px;
            text-align: justify;
            word-break: keep-all;
        }

        .interpretation-content ul, .interpretation-content ol {
            margin-bottom: 16px;
            padding-left: 25px;
        }

        .interpretation-content li {
            margin-bottom: 8px;
        }

        .interpretation-content strong {
            color: #2d3748;
            font-weight: 600;
        }

        .interpretation-content em {
            color: #4a5568;
            font-style: italic;
        }

        /* PDF ì¸ì‡„ë¥¼ ìœ„í•œ ìŠ¤íƒ€ì¼ ê°œì„  */
        @media print {
            body, html {
                background: white !important;
                margin: 0 !important;
                padding: 0 !important;
                font-family: 'Times New Roman', serif !important;
                font-size: 12pt !important;
                line-height: 1.6 !important;
                color: #000 !important;
            }
            
            /* ëª¨ë“  UI ìš”ì†Œ ìˆ¨ê¹€ */
            .header, .container, .modal-header, .modal-actions, .close-button, .action-button, .modal, .modal-content, .modal-body, .modal-footer, .stats-grid, .card, .search-controls, .pagination, .sessions-table, .stat-card, .stat-number, .stat-label, .form-group, .form-input, .form-select, .button, .button-secondary, .alert, .link-display, .link-text, .logout-btn, .user-info, .debug-info, .debug-content, .footer, .no-print, .print-hide {
                display: none !important;
            }
            
            /* ë³´ê³ ì„œ ë³¸ë¬¸ë§Œ ì¸ì‡„ */
            .print-area {
                display: block !important;
                position: static !important;
                width: 100% !important;
                height: auto !important;
                background: white !important;
                color: #000 !important;
                box-shadow: none !important;
                margin: 0 !important;
                padding: 0 !important;
                font-size: 12pt !important;
                line-height: 1.6 !important;
                page-break-inside: avoid;
            }

            .print-area .report-title-print {
                font-size: 24pt !important;
                color: #000 !important;
                text-align: center !important;
                margin-bottom: 30pt !important;
                margin-top: 0 !important;
                font-weight: bold !important;
                text-shadow: none !important;
                letter-spacing: 1pt !important;
            }

            .print-area h1 {
                font-size: 16pt !important;
                color: #000 !important;
                margin-top: 20pt !important;
                margin-bottom: 10pt !important;
                padding-bottom: 5pt !important;
                border-bottom: 1pt solid #000 !important;
                font-weight: bold !important;
            }

            .print-area h2 {
                font-size: 14pt !important;
                color: #000 !important;
                margin-top: 16pt !important;
                margin-bottom: 8pt !important;
                padding-bottom: 3pt !important;
                border-bottom: 0.5pt solid #000 !important;
                font-weight: bold !important;
            }

            .print-area h3 {
                font-size: 13pt !important;
                color: #000 !important;
                margin-top: 14pt !important;
                margin-bottom: 7pt !important;
                font-weight: bold !important;
            }

            .print-area p {
                margin-bottom: 12pt !important;
                text-align: justify !important;
                font-size: 12pt !important;
                line-height: 1.6 !important;
                word-break: keep-all !important;
            }

            .print-area ul, .print-area ol {
                margin-bottom: 12pt !important;
                padding-left: 20pt !important;
            }

            .print-area li {
                margin-bottom: 6pt !important;
                font-size: 12pt !important;
                line-height: 1.5 !important;
            }

            .print-area strong {
                color: #000 !important;
                font-weight: bold !important;
            }

            .print-area em {
                color: #000 !important;
                font-style: italic !important;
            }

            /* í˜ì´ì§€ ì„¤ì • */
            @page {
                size: A4;
                margin: 2.5cm;
                orphans: 3;
                widows: 3;
            }

            /* í˜ì´ì§€ ë‚˜ëˆ„ê¸° */
            .print-area h1, .print-area h2 {
                page-break-after: avoid;
            }

            .print-area p, .print-area li {
                page-break-inside: avoid;
            }

            /* ìŠ¤í¬ë¡¤ë°” ìˆ¨ê¹€ */
            ::-webkit-scrollbar { 
                display: none !important; 
            }
        }

        /* ë¡œë”© ë° ì•Œë¦¼ ìŠ¤íƒ€ì¼ */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: rgba(0,0,0,0.3);
            z-index: 9999;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }

        .loading-content {
            background: white;
            padding: 40px 50px;
            border-radius: 12px;
            box-shadow: 0 4px 24px rgba(0,0,0,0.15);
            font-size: 1.2em;
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
        }

        .spinner {
            margin-bottom: 20px;
        }

        .spinner svg {
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        .success-message, .error-message {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            border-radius: 8px;
            color: white;
            font-weight: 500;
            z-index: 10000;
            animation: slideIn 0.3s ease-out;
        }

        .success-message {
            background: #48bb78;
        }

        .error-message {
            background: #f56565;
        }

        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        /* ëª¨ë‹¬ ìŠ¤íƒ€ì¼ */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }

        .modal-content {
            background-color: #fefefe;
            margin: 5% auto;
            padding: 20px;
            border: 1px solid #888;
            width: 80%;
            max-width: 800px;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 1px solid #eee;
        }

        .modal-actions {
            display: flex;
            gap: 10px;
        }

        .action-button {
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            background-color: #4CAF50;
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 5px;
            transition: background-color 0.3s;
        }

        .action-button:hover {
            background-color: #45a049;
        }

        .close-button {
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            background-color: #f44336;
            color: white;
            cursor: pointer;
            font-size: 20px;
            line-height: 1;
        }

        .close-button:hover {
            background-color: #da190b;
        }

        .responses-content {
            max-height: 70vh;
            overflow-y: auto;
            padding: 20px;
            background-color: #fff;
            border-radius: 4px;
        }

        .response-item {
            margin-bottom: 20px;
            padding: 15px;
            border: 1px solid #eee;
            border-radius: 4px;
        }

        .response-item h3 {
            margin: 0 0 10px 0;
            color: #333;
        }

        .response-item p {
            margin: 0;
            color: #666;
            line-height: 1.5;
        }

        @media print {
            .modal-content {
                margin: 0;
                padding: 20px;
                width: 100%;
                max-width: none;
                box-shadow: none;
            }

            .modal-header {
                display: none;
            }

            .responses-content {
                max-height: none;
                overflow: visible;
            }
        }

        /* ë¹„ë°€ë²ˆí˜¸ ë³€ê²½ ëª¨ë‹¬ ìŠ¤íƒ€ì¼ */
        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            color: #333;
            font-weight: 500;
        }

        .form-group input {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }

        .form-group input:focus {
            border-color: #4CAF50;
            outline: none;
            box-shadow: 0 0 0 2px rgba(76, 175, 80, 0.2);
        }

        .form-actions {
            margin-top: 20px;
            text-align: right;
        }

        .primary-button {
            padding: 8px 16px;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: background-color 0.3s;
        }

        .primary-button:hover {
            background-color: #45a049;
        }

        .header-button {
            display: inline-flex;
            align-items: center;
            gap: 5px;
            padding: 8px 16px;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: background-color 0.3s;
            margin-left: 10px;
            text-decoration: none;  /* ë§í¬ ìŠ¤íƒ€ì¼ ì œê±° */
        }

        .header-button:hover {
            background-color: #45a049;
        }

        .header-button .icon {
            font-size: 16px;
        }

        /* í† ìŠ¤íŠ¸ ìŠ¤íƒ€ì¼ ì¶”ê°€ */
        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 12px 24px;
            border-radius: 4px;
            color: white;
            font-weight: 500;
            z-index: 1000;
            animation: slideIn 0.3s ease-out;
        }
        
        .toast.success {
            background-color: #4CAF50;
        }
        
        .toast.error {
            background-color: #f44336;
        }
        
        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
</head>
<body>
    <div class="header">
        <div class="header-content">
            <h1>ğŸ¥ SCT ê²€ì‚¬ ê´€ë¦¬ ì‹œìŠ¤í…œ</h1>
            <div class="user-info">
                <div>
                    <strong>ì˜ì‚¬:</strong> <span id="doctor-name">ë¡œë”©ì¤‘...</span><br>
                    <small>ID: <span id="doctor-id">ë¡œë”©ì¤‘...</span></small>
                </div>
                <a href="change_password.html" class="header-button">
                    <span class="icon">ğŸ”‘</span> ë¹„ë°€ë²ˆí˜¸ ë³€ê²½
                </a>
                <button onclick="logout()" class="header-button">
                    <span class="icon">ğŸšª</span> ë¡œê·¸ì•„ì›ƒ
                </button>
            </div>
        </div>
    </div>
    <div class="container">
        <!-- í†µê³„ ì¹´ë“œ -->
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-number" id="total-sessions">0</div>
                <div class="stat-label">ì´ ì„¸ì…˜</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="completed-sessions">0</div>
                <div class="stat-label">ì™„ë£Œëœ ê²€ì‚¬</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="pending-sessions">0</div>
                <div class="stat-label">ëŒ€ê¸° ì¤‘</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="expired-sessions">0</div>
                <div class="stat-label">ë§Œë£Œë¨</div>
            </div>
        </div>
        <!-- ìƒˆ ê²€ì‚¬ ìƒì„± -->
        <div class="card">
            <h2>ğŸ†• ìƒˆ SCT ê²€ì‚¬ ìƒì„±</h2>
            <form id="create-session-form">
                <div class="form-group">
                    <label for="patient-name">í™˜ì ì´ë¦„</label>
                    <input type="text" id="patient-name" class="form-input" placeholder="í™˜ì ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”" required>
                </div>
                <button type="submit" class="button">ê²€ì‚¬ ì„¸ì…˜ ìƒì„±</button>
            </form>
            <div id="new-session-alert" class="alert alert-success" style="display: none;">
                <strong>âœ… ìƒˆ ê²€ì‚¬ê°€ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤!</strong>
                <div class="link-display">
                    <p><strong>í™˜ìì—ê²Œ ì „ë‹¬í•  ê²€ì‚¬ ë§í¬:</strong></p>
                    <div class="link-text" id="patient-link"></div>
                    <div style="display: flex; gap: 10px;">
                        <button onclick="copyLink()" class="button button-secondary">ğŸ“‹ ë§í¬ ë³µì‚¬</button>
                        <button onclick="sendKakaoLink()" class="button">ğŸ’¬ ì¹´ì¹´ì˜¤í†¡ ì „ì†¡</button>
                    </div>
                </div>
            </div>
        </div>
        <!-- ê²€ì‚¬ ëª©ë¡ -->
        <div class="card">
            <h2>ğŸ“‹ ê²€ì‚¬ ì„¸ì…˜ ëª©ë¡</h2>
            
            <!-- ê²€ìƒ‰ ë° í•„í„° ì»¨íŠ¸ë¡¤ -->
            <div class="search-controls">
                <input type="text" class="search-input" id="search-patient" placeholder="ğŸ” í™˜ì ì´ë¦„ìœ¼ë¡œ ê²€ìƒ‰...">
                <select class="filter-select" id="status-filter">
                    <option value="">ì „ì²´ ìƒíƒœ</option>
                    <option value="complete">ì™„ë£Œ</option>
                    <option value="incomplete">ëŒ€ê¸°ì¤‘</option>
                    <option value="expired">ë§Œë£Œ</option>
                </select>
                <input type="date" class="search-input" id="date-from" title="ì‹œì‘ì¼">
                <input type="date" class="search-input" id="date-to" title="ì¢…ë£Œì¼">
                <button onclick="resetFilters()" class="button button-secondary">ğŸ”„ ì´ˆê¸°í™”</button>
            </div>
            
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <button onclick="refreshSessions()" class="button button-secondary">ğŸ”„ ìƒˆë¡œê³ ì¹¨</button>
                <div class="pagination-info" id="pagination-info">0ê°œ ê²°ê³¼</div>
            </div>
            
            <div id="sessions-loading" class="loading" style="display: none;">
                ê²€ì‚¬ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...
            </div>
            
            <table class="sessions-table" id="sessions-table" style="display: none;">
                <thead>
                    <tr>
                        <th>í™˜ìëª…</th>
                        <th>ìƒì„±ì¼</th>
                        <th>ì œì¶œì¼</th>
                        <th>ë§Œë£Œì¼</th>
                        <th>ìƒíƒœ</th>
                        <th>ì‘ì—…</th>
                    </tr>
                </thead>
                <tbody id="sessions-tbody">
                </tbody>
            </table>
            
            <!-- í˜ì´ì§• -->
            <div class="pagination" id="pagination" style="display: none;">
                <button onclick="goToPage(1)" id="first-page"><<</button>
                <button onclick="goToPage(currentPage - 1)" id="prev-page"><</button>
                <div id="page-numbers"></div>
                <button onclick="goToPage(currentPage + 1)" id="next-page">></button>
                <button onclick="goToPage(totalPages)" id="last-page">>></button>
            </div>
            
            <div id="no-sessions" style="display: none; text-align: center; color: #718096; padding: 40px;">
                ê²€ìƒ‰ ì¡°ê±´ì— ë§ëŠ” ê²€ì‚¬ ì„¸ì…˜ì´ ì—†ìŠµë‹ˆë‹¤.
            </div>
        </div>
    </div>
    
    <!-- í•´ì„ ê²°ê³¼ ëª¨ë‹¬ -->
    <div id="interpretation-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>SCT í•´ì„ ê²°ê³¼</h2>
                <div class="modal-actions">
                    <button onclick="downloadPDF()" class="action-button">
                        <span class="icon">ğŸ“„</span> PDF ë‹¤ìš´ë¡œë“œ
                    </button>
                    <button onclick="printInterpretation()" class="action-button">
                        <span class="icon">ğŸ–¨ï¸</span> ì¸ì‡„
                    </button>
                    <button onclick="regenerateInterpretation()" class="action-button">
                        <span class="icon">ğŸ”„</span> ì¬ìƒì„±
                    </button>
                    <button onclick="showOriginalResponses()" class="action-button">
                        <span class="icon">ğŸ“</span> ì›ë³¸ ì‘ë‹µ
                    </button>
                    <button onclick="closeModal('interpretation-modal')" class="close-button">Ã—</button>
            </div>
                </div>
            <div class="modal-body">
                <div id="interpretation-content" class="interpretation-content"></div>
            </div>
                </div>
            </div>
            
    <!-- ì›ë³¸ ì‘ë‹µ ëª¨ë‹¬ -->
    <div id="responses-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>ì›ë³¸ ì‘ë‹µ</h2>
                <div class="modal-actions">
                    <button onclick="downloadResponsesPDF()" class="action-button">
                        <span class="icon">ğŸ“„</span> PDF ë‹¤ìš´ë¡œë“œ
                    </button>
                    <button onclick="printResponses()" class="action-button">
                        <span class="icon">ğŸ–¨ï¸</span> ì¸ì‡„
                    </button>
                    <button onclick="closeModal('responses-modal')" class="close-button">Ã—</button>
                </div>
            </div>
            <div class="modal-body">
                <div id="responses-content" class="responses-content"></div>
            </div>
        </div>
    </div>

    <!-- PDF ìƒì„±ì„ ìœ„í•œ ìˆ¨ê²¨ì§„ ì˜ì—­ -->
    <div id="print-area" class="print-area" style="display: none;"></div>

    <script>
        // === API ì„œë²„ ì£¼ì†Œë¥¼ ì—¬ê¸°ì— ì„¤ì •í•˜ì„¸ìš” ===
        const API_BASE = "https://sct-backend-7epf.onrender.com";
        // ======================================
        let doctorId = '';
        let doctorName = '';
        let allSessions = []; // ì „ì²´ ì„¸ì…˜ ë°ì´í„°
        let filteredSessions = []; // í•„í„°ë§ëœ ì„¸ì…˜ ë°ì´í„°
        let currentSessionLink = '';
        let currentSessionId = '';
        let currentInterpretation = '';
        let debugMode = false;
        
        // í˜ì´ì§• ê´€ë ¨ ë³€ìˆ˜
        let currentPage = 1;
        let itemsPerPage = 10;
        let totalPages = 1;
        
        // ë””ë²„ê·¸ í•¨ìˆ˜
        function debugLog(message, data = null) {
            const timestamp = new Date().toLocaleTimeString();
            const logMessage = `[${timestamp}] ${message}`;
            console.log(logMessage, data || '');
        }
        
        // API í—¤ë” (JWT í† í° í¬í•¨)
        function getApiHeaders() {
            const token = localStorage.getItem('access_token');
            return {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${token}`
            };
        }
        
        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì‹¤í–‰
        document.addEventListener('DOMContentLoaded', function() {
            debugLog('í˜ì´ì§€ ë¡œë“œ ì‹œì‘');
            
            // ë¡œê·¸ì¸ í™•ì¸
            const currentUser = localStorage.getItem('currentUser');
            if (!currentUser) {
                alert('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.');
                window.location.href = 'login.html';
                return;
            }
            
            // ì‚¬ìš©ì ì •ë³´ ì„¤ì •
            const userData = JSON.parse(currentUser);
            doctorId = userData.doctorId;
            doctorName = userData.name;
            
            debugLog('ì‚¬ìš©ì ì •ë³´ ë¡œë“œ', { doctorId, doctorName });
            
            document.getElementById('doctor-id').textContent = doctorId;
            document.getElementById('doctor-name').textContent = doctorName;
            
            loadSessions();
            setupEventListeners();
        });
        
        // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì„¤ì •
        function setupEventListeners() {
            // í¼ ì œì¶œ ì´ë²¤íŠ¸
            document.getElementById('create-session-form').addEventListener('submit', createSession);
            
            // ê²€ìƒ‰ ë° í•„í„° ì´ë²¤íŠ¸
            document.getElementById('search-patient').addEventListener('input', applyFilters);
            document.getElementById('status-filter').addEventListener('change', applyFilters);
            document.getElementById('date-from').addEventListener('change', applyFilters);
            document.getElementById('date-to').addEventListener('change', applyFilters);
        }
        
        // ë¡œê·¸ì•„ì›ƒ
        function logout() {
            if (confirm('ì •ë§ ë¡œê·¸ì•„ì›ƒ í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                localStorage.removeItem('currentUser');
                localStorage.removeItem('access_token');
                window.location.href = 'login.html';
            }
        }
        
        // ìƒˆ ì„¸ì…˜ ìƒì„±
        async function createSession(event) {
            event.preventDefault();
            
            const patientName = document.getElementById('patient-name').value.trim();
            if (!patientName) {
                alert('í™˜ì ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return;
            }
            
            debugLog('ìƒˆ ì„¸ì…˜ ìƒì„± ì‹œì‘', { patientName, doctorId });
            
            try {
                const requestBody = {
                    patient_name: patientName
                };
                
                debugLog('ì „ì†¡í•  ë°ì´í„°', requestBody);
                
                const response = await fetch(`${API_BASE}/sct/sessions`, {
                    method: 'POST',
                    headers: getApiHeaders(),
                    body: JSON.stringify(requestBody)
                });
                
                debugLog('ì„¸ì…˜ ìƒì„± ì‘ë‹µ ìƒíƒœ', response.status);
                
                if (!response.ok) {
                    if (response.status === 401) {
                        alert('ë¡œê·¸ì¸ì´ ë§Œë£Œë˜ì—ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ë¡œê·¸ì¸í•´ì£¼ì„¸ìš”.');
                        localStorage.removeItem('access_token');
                        localStorage.removeItem('currentUser');
                        window.location.href = 'login.html';
                        return;
                    }
                    const errorData = await response.json();
                    debugLog('ì„¸ì…˜ ìƒì„± ì˜¤ë¥˜', errorData);
                    throw new Error(errorData.detail || 'ì„¸ì…˜ ìƒì„±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                }
                
                const sessionData = await response.json();
                debugLog('ìƒì„±ëœ ì„¸ì…˜', sessionData);
                
                // ì„±ê³µ ë©”ì‹œì§€ ë° ë§í¬ í‘œì‹œ
                const patientLink = `${window.location.origin}/patient.html?session=${sessionData.session_id}`;
                currentSessionLink = patientLink;

                // ë§í¬ í…ìŠ¤íŠ¸ ì„¤ì •
                const linkElement = document.getElementById('patient-link');
                if (linkElement) {
                    linkElement.textContent = patientLink;
                }

                // ì•Œë¦¼ í‘œì‹œ
                const alertElement = document.getElementById('new-session-alert');
                if (alertElement) {
                    alertElement.style.display = 'block';
                }

                // ë§í¬ í‘œì‹œ ì˜ì—­ë„ í‘œì‹œ
                const linkDisplayElement = document.querySelector('.link-display');
                if (linkDisplayElement) {
                    linkDisplayElement.style.display = 'block';
                }
                
                // í¼ ì´ˆê¸°í™”
                document.getElementById('patient-name').value = '';
                
                // ì„¸ì…˜ ëª©ë¡ ìƒˆë¡œê³ ì¹¨
                await loadSessions();
                
            } catch (error) {
                debugLog('ì„¸ì…˜ ìƒì„± ì˜¤ë¥˜', error.message);
                alert('ì„¸ì…˜ ìƒì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
            }
        }
        
        // ì„¸ì…˜ ëª©ë¡ ë¡œë“œ
        async function loadSessions() {
            debugLog('ì„¸ì…˜ ëª©ë¡ ë¡œë“œ ì‹œì‘');
            document.getElementById('sessions-loading').style.display = 'block';
            document.getElementById('sessions-table').style.display = 'none';
            document.getElementById('no-sessions').style.display = 'none';
            document.getElementById('pagination').style.display = 'none';
            
            try {
                const url = `${API_BASE}/sct/sessions/by-user/${doctorId}`;
                debugLog('API ìš”ì²­ URL', url);
                
                const response = await fetch(url, {
                    headers: getApiHeaders()
                });
                
                debugLog('API ì‘ë‹µ ìƒíƒœ', response.status);
                
                if (!response.ok) {
                    if (response.status === 401) {
                        alert('ë¡œê·¸ì¸ì´ ë§Œë£Œë˜ì—ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ë¡œê·¸ì¸í•´ì£¼ì„¸ìš”.');
                        localStorage.removeItem('access_token');
                        localStorage.removeItem('currentUser');
                        window.location.href = 'login.html';
                        return;
                    }
                    const errorText = await response.text();
                    debugLog('API ì‘ë‹µ ì˜¤ë¥˜', errorText);
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                debugLog('ë°›ì€ ë°ì´í„°', data);
                
                // ë°ì´í„° êµ¬ì¡° í™•ì¸ ë° ì •ê·œí™”
                allSessions = Array.isArray(data) ? data : (data.sessions || []);
                debugLog('ì²˜ë¦¬ëœ ì„¸ì…˜ ë°ì´í„°', allSessions);
                
                // ì´ˆê¸° í•„í„°ë§ ë° ë Œë”ë§
                applyFilters();
                updateStats();
                
            } catch (error) {
                debugLog('ì„¸ì…˜ ë¡œë“œ ì˜¤ë¥˜', error.message);
                alert('ì„¸ì…˜ ëª©ë¡ ë¡œë“œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
                
                // ì˜¤ë¥˜ ë°œìƒ ì‹œ ë¹ˆ ë°°ì—´ë¡œ ì´ˆê¸°í™”
                allSessions = [];
                filteredSessions = [];
                updateStats();
                renderSessionsTable();
            } finally {
                document.getElementById('sessions-loading').style.display = 'none';
            }
        }
        
        // í•„í„° ì ìš©
        function applyFilters() {
            const searchTerm = document.getElementById('search-patient').value.toLowerCase().trim();
            const statusFilter = document.getElementById('status-filter').value;
            const dateFrom = document.getElementById('date-from').value;
            const dateTo = document.getElementById('date-to').value;
            
            debugLog('í•„í„° ì ìš©', { searchTerm, statusFilter, dateFrom, dateTo });
            
            filteredSessions = allSessions.filter(session => {
                // í™˜ìëª… ê²€ìƒ‰
                if (searchTerm) {
                    const patientName = (session.patient_name || session.patientName || '').toLowerCase();
                    if (!patientName.includes(searchTerm)) {
                        return false;
                    }
                }
                
                // ìƒíƒœ í•„í„°
                if (statusFilter && session.status !== statusFilter) {
                    return false;
                }
                
                // ë‚ ì§œ ë²”ìœ„ í•„í„°
                if (dateFrom || dateTo) {
                    const sessionDate = new Date(session.created_at || session.createdAt);
                    
                    if (dateFrom) {
                        const fromDate = new Date(dateFrom);
                        if (sessionDate < fromDate) {
                            return false;
                        }
                    }
                    
                    if (dateTo) {
                        const toDate = new Date(dateTo);
                        toDate.setHours(23, 59, 59, 999); // í•˜ë£¨ ëê¹Œì§€
                        if (sessionDate > toDate) {
                            return false;
                        }
                    }
                }
                
                return true;
            });
            
            debugLog('í•„í„°ë§ ê²°ê³¼', `${filteredSessions.length}/${allSessions.length}`);
            
            // í˜ì´ì§• ì´ˆê¸°í™”
            currentPage = 1;
            calculatePagination();
            renderSessionsTable();
            renderPagination();
        }
        
        // í•„í„° ì´ˆê¸°í™”
        function resetFilters() {
            document.getElementById('search-patient').value = '';
            document.getElementById('status-filter').value = '';
            document.getElementById('date-from').value = '';
            document.getElementById('date-to').value = '';
            applyFilters();
        }
        
        // í˜ì´ì§• ê³„ì‚°
        function calculatePagination() {
            totalPages = Math.ceil(filteredSessions.length / itemsPerPage);
            if (totalPages === 0) totalPages = 1;
            if (currentPage > totalPages) currentPage = totalPages;
        }
        
        // í˜ì´ì§€ ì´ë™
        function goToPage(page) {
            if (page < 1 || page > totalPages) return;
            currentPage = page;
            renderSessionsTable();
            renderPagination();
        }
        
        // í˜ì´ì§• UI ë Œë”ë§
        function renderPagination() {
            const pagination = document.getElementById('pagination');
            const pageNumbers = document.getElementById('page-numbers');
            const paginationInfo = document.getElementById('pagination-info');
            
            if (filteredSessions.length === 0) {
                pagination.style.display = 'none';
                paginationInfo.textContent = '0ê°œ ê²°ê³¼';
                return;
            }
            
            pagination.style.display = 'flex';
            
            // í˜ì´ì§€ ì •ë³´
            const startItem = (currentPage - 1) * itemsPerPage + 1;
            const endItem = Math.min(currentPage * itemsPerPage, filteredSessions.length);
            paginationInfo.textContent = `${startItem}-${endItem} / ì´ ${filteredSessions.length}ê°œ`;
            
            // ì´ì „/ë‹¤ìŒ ë²„íŠ¼ ìƒíƒœ
            document.getElementById('first-page').disabled = currentPage === 1;
            document.getElementById('prev-page').disabled = currentPage === 1;
            document.getElementById('next-page').disabled = currentPage === totalPages;
            document.getElementById('last-page').disabled = currentPage === totalPages;
            
            // í˜ì´ì§€ ë²ˆí˜¸ ë²„íŠ¼
            pageNumbers.innerHTML = '';
            const maxVisiblePages = 5;
            let startPage = Math.max(1, currentPage - Math.floor(maxVisiblePages / 2));
            let endPage = Math.min(totalPages, startPage + maxVisiblePages - 1);
            
            if (endPage - startPage + 1 < maxVisiblePages) {
                startPage = Math.max(1, endPage - maxVisiblePages + 1);
            }
            
            for (let i = startPage; i <= endPage; i++) {
                const button = document.createElement('button');
                button.textContent = i;
                button.onclick = () => goToPage(i);
                if (i === currentPage) {
                    button.classList.add('active');
                }
                pageNumbers.appendChild(button);
            }
        }
        
        // í†µê³„ ì—…ë°ì´íŠ¸
        function updateStats() {
            debugLog('í†µê³„ ì—…ë°ì´íŠ¸', allSessions);
            
            const total = allSessions ? allSessions.length : 0;
            const completed = allSessions ? allSessions.filter(s => s.status === 'complete').length : 0;
            const pending = allSessions ? allSessions.filter(s => s.status === 'incomplete').length : 0;
            const expired = allSessions ? allSessions.filter(s => s.status === 'expired').length : 0;
            
            debugLog('í†µê³„ ê²°ê³¼', { total, completed, pending, expired });
            
            document.getElementById('total-sessions').textContent = total;
            document.getElementById('completed-sessions').textContent = completed;
            document.getElementById('pending-sessions').textContent = pending;
            document.getElementById('expired-sessions').textContent = expired;
        }
        
        // ì„¸ì…˜ í…Œì´ë¸” ë Œë”ë§
        function renderSessionsTable() {
            debugLog('í…Œì´ë¸” ë Œë”ë§ ì‹œì‘', `í•„í„°ë§ëœ ì„¸ì…˜ ìˆ˜: ${filteredSessions.length}`);
            const tbody = document.getElementById('sessions-tbody');
            tbody.innerHTML = '';
            
            if (!filteredSessions || filteredSessions.length === 0) {
                document.getElementById('no-sessions').style.display = 'block';
                document.getElementById('sessions-table').style.display = 'none';
                debugLog('í•„í„°ë§ëœ ì„¸ì…˜ì´ ì—†ìŒ');
                return;
            }
            
            document.getElementById('sessions-table').style.display = 'table';
            document.getElementById('no-sessions').style.display = 'none';
            
            // í˜ì´ì§• ì ìš©
            const startIndex = (currentPage - 1) * itemsPerPage;
            const endIndex = startIndex + itemsPerPage;
            const currentPageSessions = filteredSessions.slice(startIndex, endIndex);
            
            currentPageSessions.forEach((session, index) => {
                debugLog(`ì„¸ì…˜ ${startIndex + index + 1} ì²˜ë¦¬`, session);
                
                const row = document.createElement('tr');
                
                // ì•ˆì „í•œ ë°ì´í„° ì¶”ì¶œ
                let patientName = 'UNKNOWN';
                
                if (session.patient_name && session.patient_name.trim() !== '') {
                    patientName = session.patient_name.trim();
                } else if (session.patientName && session.patientName.trim() !== '') {
                    patientName = session.patientName.trim();
                } else {
                    console.warn('âŒ í™˜ì ì´ë¦„ì„ ì°¾ì„ ìˆ˜ ì—†ìŒ, ì„¸ì…˜ ì „ì²´:', session);
                    patientName = 'NO_NAME_FOUND';
                }
                
                const sessionId = session.session_id || session.sessionId || 'Unknown';
                const status = session.status || 'unknown';
                
                // ë‚ ì§œ í¬ë§·íŒ… (KST ê¸°ì¤€)
                const createdAt = formatDate(session.created_at || session.createdAt);
                const submittedAt = formatDate(session.submitted_at || session.submittedAt);
                const expiresAt = formatDate(session.expires_at || session.expiresAt);
                
                // ìƒíƒœ ë±ƒì§€
                const { statusClass, statusText } = getStatusInfo(status);
                
                // ì‘ì—… ë²„íŠ¼ë“¤
                const actionButtons = generateActionButtons(session, sessionId);
                
                row.innerHTML = `
                    <td>${patientName}</td>
                    <td>${createdAt}</td>
                    <td>${submittedAt}</td>
                    <td>${expiresAt}</td>
                    <td><span class="status-badge ${statusClass}">${statusText}</span></td>
                    <td>
                        <div class="action-buttons">
                            ${actionButtons}
                        </div>
                    </td>
                `;
                
                tbody.appendChild(row);
            });
            
            debugLog('í…Œì´ë¸” ë Œë”ë§ ì™„ë£Œ');
        }
        
        // ì•ˆì „í•œ ë‚ ì§œ í¬ë§·íŒ… í•¨ìˆ˜ (KST ê¸°ì¤€)
        function formatDate(dateString) {
            if (!dateString) return '-';
            try {
                const date = new Date(dateString);
                if (isNaN(date.getTime())) return 'Invalid Date';
                return date.toLocaleString('ko-KR', {
                    year: 'numeric',
                    month: '2-digit',
                    day: '2-digit',
                    hour: '2-digit',
                    minute: '2-digit',
                    timeZone: 'Asia/Seoul'
                });
            } catch {
                return 'Format Error';
            }
        }
        
        // ìƒíƒœ ì •ë³´ ë°˜í™˜
        function getStatusInfo(status) {
            let statusClass = '';
            let statusText = '';
            
            switch (status) {
                case 'incomplete':
                    statusClass = 'status-incomplete';
                    statusText = 'ëŒ€ê¸°ì¤‘';
                    break;
                case 'complete':
                    statusClass = 'status-complete';
                    statusText = 'ì™„ë£Œ';
                    break;
                case 'expired':
                    statusClass = 'status-expired';
                    statusText = 'ë§Œë£Œ';
                    break;
                default:
                    statusClass = 'status-incomplete';
                    statusText = 'ì•Œ ìˆ˜ ì—†ìŒ';
            }
            
            return { statusClass, statusText };
        }
        
        // ì‘ì—… ë²„íŠ¼ ìƒì„±
        function generateActionButtons(session, sessionId) {
            const status = session.status || 'incomplete';
            let actionButtons = '';
            
            if (status === 'incomplete') {
                const patientLink = `${window.location.origin}/patient.html?session=${sessionId}`;
                actionButtons = `
                    <button onclick="copySessionLink('${patientLink}')" class="action-button copy">ë§í¬ ë³µì‚¬</button>
                    <button onclick="deleteSession('${sessionId}')" class="action-button delete">ì‚­ì œ</button>
                `;
            } else if (status === 'complete') {
                actionButtons = `
                    <button onclick="openAnalysisModal('${sessionId}')" class="action-button interpret">ğŸ“Š ì „ë¬¸ í•´ì„</button>
                    <button onclick="deleteSession('${sessionId}')" class="action-button delete">ì‚­ì œ</button>
                `;
            } else {
                actionButtons = `
                    <button onclick="deleteSession('${sessionId}')" class="action-button delete">ì‚­ì œ</button>
                `;
            }
            
            return actionButtons;
        }
        
        // ì„¸ì…˜ ì‚­ì œ
        async function deleteSession(sessionId) {
            const session = allSessions.find(s => s.session_id === sessionId);
            const patientName = session ? (session.patient_name || session.patientName || 'Unknown') : 'Unknown';
            
            if (!confirm(`ì •ë§ë¡œ "${patientName}"ì˜ ê²€ì‚¬ ì„¸ì…˜ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\nì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.`)) {
                return;
            }
            
            try {
                debugLog('ì„¸ì…˜ ì‚­ì œ ì‹œë„', sessionId);
                
                const response = await fetch(`${API_BASE}/sct/sessions/${sessionId}`, {
                    method: 'DELETE',
                    headers: getApiHeaders()
                });
                
                if (!response.ok) {
                    if (response.status === 401) {
                        alert('ë¡œê·¸ì¸ì´ ë§Œë£Œë˜ì—ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ë¡œê·¸ì¸í•´ì£¼ì„¸ìš”.');
                        localStorage.removeItem('access_token');
                        localStorage.removeItem('currentUser');
                        window.location.href = 'login.html';
                        return;
                    }
                    throw new Error('ì„¸ì…˜ ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                }
                
                showSuccess('ì„¸ì…˜ì´ ì„±ê³µì ìœ¼ë¡œ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
                
                // ì„¸ì…˜ ëª©ë¡ ìƒˆë¡œê³ ì¹¨
                await loadSessions();
                
            } catch (error) {
                debugLog('ì„¸ì…˜ ì‚­ì œ ì˜¤ë¥˜', error.message);
                showError('ì„¸ì…˜ ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
            }
        }
        
        // ë§í¬ ë³µì‚¬
        function copyLink() {
            navigator.clipboard.writeText(currentSessionLink).then(() => {
                showSuccess('ë§í¬ê°€ í´ë¦½ë³´ë“œì— ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤!');
            });
        }
        
        // ì„¸ì…˜ ë§í¬ ë³µì‚¬
        function copySessionLink(link) {
            navigator.clipboard.writeText(link).then(() => {
                showSuccess('ê²€ì‚¬ ë§í¬ê°€ í´ë¦½ë³´ë“œì— ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤!');
            });
        }
        
        // ì¹´ì¹´ì˜¤í†¡ ì „ì†¡
        function sendKakaoLink() {
            showError('ì¹´ì¹´ì˜¤í†¡ ì „ì†¡ ê¸°ëŠ¥ì€ ì¶”í›„ êµ¬í˜„ ì˜ˆì •ì…ë‹ˆë‹¤.\ní˜„ì¬ëŠ” ë§í¬ë¥¼ ë³µì‚¬í•´ì„œ ì§ì ‘ ì „ì†¡í•´ì£¼ì„¸ìš”.');
        }
        
        // ì„¸ì…˜ ëª©ë¡ ìƒˆë¡œê³ ì¹¨
        function refreshSessions() {
            debugLog('ì„¸ì…˜ ëª©ë¡ ìƒˆë¡œê³ ì¹¨ ìš”ì²­');
            loadSessions();
        }
        
        // ë¶„ì„ ëª¨ë‹¬ ì—´ê¸°
        async function openAnalysisModal(sessionId) {
            debugLog('ë¶„ì„ ëª¨ë‹¬ ì—´ê¸°', sessionId);
            currentSessionId = sessionId;

            // ëª¨ë‹¬ ì—´ê¸°
            document.getElementById('interpretation-modal').style.display = 'block';
            document.getElementById('interpretation-content').innerHTML = '<div style="text-align: center; padding: 40px;">ë¡œë”©ì¤‘...</div>';

            try {
                showLoading('í•´ì„ ê²°ê³¼ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤...');
                
                let interpretationResponse = await fetch(`${API_BASE}/sct/sessions/${sessionId}/interpretation`, {
                    headers: getApiHeaders()
                });
                
                if (interpretationResponse.status === 404) {
                    // í•´ì„ì´ ì—†ìœ¼ë©´ ìƒˆë¡œ ìƒì„±
                    showLoading('ìƒˆë¡œìš´ í•´ì„ì„ ìƒì„±í•˜ëŠ” ì¤‘ì…ë‹ˆë‹¤...');
                    await fetch(`${API_BASE}/sct/sessions/${sessionId}/interpret`, {
                        method: 'POST',
                        headers: getApiHeaders()
                    });
                    interpretationResponse = await fetch(`${API_BASE}/sct/sessions/${sessionId}/interpretation`, {
                        headers: getApiHeaders()
                    });
                }
                
                if (!interpretationResponse.ok) {
                    throw new Error('í•´ì„ ê²°ê³¼ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                }
                
                const data = await interpretationResponse.json();
                currentInterpretation = data.interpretation;
                renderInterpretationWithTitle(data.interpretation);
                
            } catch (error) {
                document.getElementById('interpretation-content').innerHTML = `<div style="color:red; text-align: center; padding: 40px;">âŒ ì˜¤ë¥˜: ${error.message}</div>`;
                showError('í•´ì„ ê²°ê³¼ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            } finally {
                hideLoading();
            }
        }
        
        // í•´ì„ ì¬ìƒì„± í•¨ìˆ˜
        async function regenerateInterpretation() {
            const sessionId = currentSessionId;
            if (!sessionId) return;

            try {
                showLoading('í•´ì„ì„ ì¬ìƒì„±í•˜ëŠ” ì¤‘ì…ë‹ˆë‹¤...');
                
                const response = await fetch(`${API_BASE}/sct/sessions/${sessionId}/regenerate`, {
                    method: 'POST',
                    headers: getApiHeaders()
                });
                
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.detail || 'í•´ì„ ì¬ìƒì„±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                }
                
                const data = await response.json();
                
                // ì„±ê³µ ë©”ì‹œì§€ í‘œì‹œ
                showToast('success', data.message || 'í•´ì„ì´ ì„±ê³µì ìœ¼ë¡œ ì¬ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤.');
                
                // í•´ì„ ë‚´ìš© ì—…ë°ì´íŠ¸
                const interpretationElement = document.getElementById('interpretation-content');
                if (interpretationElement) {
                    interpretationElement.innerHTML = marked.parse(data.interpretation);
                }
                
                // í•´ì„ ì‹œê°„ ì—…ë°ì´íŠ¸
                const timeElement = document.getElementById('interpretation-time');
                if (timeElement) {
                    timeElement.textContent = new Date(data.generated_at).toLocaleString();
                }
                
            } catch (error) {
                console.error('í•´ì„ ì¬ìƒì„± ì˜¤ë¥˜:', error);
                showToast('error', error.message || 'í•´ì„ ì¬ìƒì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            } finally {
                hideLoading();
            }
        }

        // ì›ë³¸ ì‘ë‹µ ë³´ê¸° í•¨ìˆ˜
        async function showOriginalResponses() {
            const sessionId = currentSessionId;
            if (!sessionId) return;

            try {
                showLoading('ì‘ë‹µì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤...');
                
                const response = await fetch(`${API_BASE}/sct/sessions/${sessionId}/responses`, {
                    headers: getApiHeaders()
                });
                
                if (!response.ok) {
                    throw new Error('ì‘ë‹µ ì¡°íšŒì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                }
                
                const data = await response.json();
                
                // ì‘ë‹µ ë‚´ìš© êµ¬ì„±
                const responsesHtml = data.responses.map(r => `
                            <div class="response-item">
                        <div class="item-number">ë¬¸í•­ ${r.item_no}</div>
                        <div class="stem">${r.stem}</div>
                        <div class="answer">${r.answer}</div>
                            </div>
                `).join('');
                
                document.getElementById('responses-content').innerHTML = responsesHtml;
                
                // ì›ë³¸ ì‘ë‹µ ëª¨ë‹¬ í‘œì‹œ
                document.getElementById('interpretation-modal').style.display = 'none';
                document.getElementById('responses-modal').style.display = 'block';
                
            } catch (error) {
                console.error('ì‘ë‹µ ì¡°íšŒ ì˜¤ë¥˜:', error);
                showError('ì‘ë‹µ ì¡°íšŒ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            } finally {
                hideLoading();
            }
        }

        // ëª¨ë‹¬ ë‹«ê¸° í•¨ìˆ˜
        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
            if (modalId === 'responses-modal') {
                document.getElementById('interpretation-modal').style.display = 'block';
            }
        }

        // PDF ë‹¤ìš´ë¡œë“œ í•¨ìˆ˜ (ê°œì„ ë¨)
        async function downloadPDF() {
            if (!currentInterpretation) {
                showError('ë‹¤ìš´ë¡œë“œí•  í•´ì„ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }
            
            try {
                showLoading('PDFë¥¼ ìƒì„±í•˜ëŠ” ì¤‘ì…ë‹ˆë‹¤...');
                
                // í˜„ì¬ ì„¸ì…˜ ì •ë³´ ê°€ì ¸ì˜¤ê¸°
                const session = allSessions.find(s => s.session_id === currentSessionId);
                const patientName = session ? (session.patient_name || session.patientName || 'Unknown') : 'Unknown';
                const today = new Date().toLocaleDateString('ko-KR');
                
                // ë³´ê³ ì„œ ë‚´ìš© í¬ë§·íŒ…
                const formattedContent = formatReportContent(currentInterpretation);
                
                // PDF ìƒì„±ì„ ìœ„í•œ HTML ì¤€ë¹„
                const printContent = `
                    <div class="report-title-print">ë¬¸ì¥ì™„ì„±ê²€ì‚¬ ë³´ê³ ì„œ</div>
                    <div style="margin-bottom: 30px; text-align: center; color: #666;">
                        <p><strong>í™˜ìëª…:</strong> ${patientName}</p>
                        <p><strong>ê²€ì‚¬ì¼:</strong> ${today}</p>
                        <p><strong>ë‹´ë‹¹ì˜:</strong> ${doctorName}</p>
                    </div>
                    ${formattedContent}
                `;
                
                // ìˆ¨ê²¨ì§„ ì¸ì‡„ ì˜ì—­ì— ë‚´ìš© ì„¤ì •
                const printArea = document.getElementById('print-area');
                printArea.innerHTML = printContent;
                printArea.style.display = 'block';
                
                // ë¸Œë¼ìš°ì €ì˜ ì¸ì‡„ ë‹¤ì´ì–¼ë¡œê·¸ ì—´ê¸°
                setTimeout(() => {
                    window.print();
                    printArea.style.display = 'none';
                }, 100);
                
            } catch (error) {
                console.error('PDF ìƒì„± ì˜¤ë¥˜:', error);
                showError('PDF ìƒì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            } finally {
                hideLoading();
            }
        }

        // ì¸ì‡„ í•¨ìˆ˜ (ê°œì„ ë¨)
        function printInterpretation() {
            downloadPDF(); // ê°™ì€ ê¸°ëŠ¥ ì‚¬ìš©
        }

        // ë¡œë”© í‘œì‹œ í•¨ìˆ˜
        function showLoading(message = 'ì²˜ë¦¬ ì¤‘ì…ë‹ˆë‹¤...') {
            if (document.getElementById('global-loading')) return;
            
            const loadingDiv = document.createElement('div');
            loadingDiv.id = 'global-loading';
            loadingDiv.className = 'loading-overlay';
            loadingDiv.innerHTML = `
                <div class="loading-content">
                    <div class="spinner">
                        <svg width="40" height="40" viewBox="0 0 40 40">
                            <circle cx="20" cy="20" r="16" stroke="#4299e1" stroke-width="4" fill="none" 
                                    stroke-dasharray="80" stroke-dashoffset="60">
                                <animateTransform attributeName="transform" type="rotate" 
                                                from="0 20 20" to="360 20 20" dur="1s" repeatCount="indefinite"/>
                            </circle>
                        </svg>
                    </div>
                    <div>${message}</div>
                </div>
            `;
            document.body.appendChild(loadingDiv);
        }

        // ë¡œë”© ìˆ¨ê¸°ê¸° í•¨ìˆ˜
        function hideLoading() {
            const loadingDiv = document.getElementById('global-loading');
            if (loadingDiv) {
                loadingDiv.remove();
            }
        }

        // ì„±ê³µ ë©”ì‹œì§€ í‘œì‹œ
        function showSuccess(message) {
            const successDiv = document.createElement('div');
            successDiv.className = 'success-message';
            successDiv.textContent = message;
            document.body.appendChild(successDiv);
            
            setTimeout(() => {
                successDiv.remove();
            }, 3000);
        }

        // ì˜¤ë¥˜ ë©”ì‹œì§€ í‘œì‹œ
        function showError(message) {
            const errorDiv = document.createElement('div');
            errorDiv.className = 'error-message';
            errorDiv.textContent = message;
            document.body.appendChild(errorDiv);
            
            setTimeout(() => {
                errorDiv.remove();
            }, 5000);
        }

        // í•´ì„ ê²°ê³¼ë¥¼ í‘œì‹œí•  ë•Œ ë§¨ ìœ„ì— ì œëª©ì„ ì¶”ê°€
        function renderInterpretationWithTitle(content) {
            const session = allSessions.find(s => s.session_id === currentSessionId);
            const patientName = session ? (session.patient_name || session.patientName || 'Unknown') : 'Unknown';
            const today = new Date().toLocaleDateString('ko-KR');
            
            // ë³´ê³ ì„œ ë‚´ìš© í¬ë§·íŒ…
            const formattedContent = formatReportContent(content);
            
            const title = `
                <div class="report-title-print">ë¬¸ì¥ì™„ì„±ê²€ì‚¬ ë³´ê³ ì„œ</div>
                <div style="margin-bottom: 30px; text-align: center; color: #666; border-bottom: 2px solid #e2e8f0; padding-bottom: 20px;">
                    <p style="margin: 5px 0;"><strong>í™˜ìëª…:</strong> ${patientName}</p>
                    <p style="margin: 5px 0;"><strong>ê²€ì‚¬ì¼:</strong> ${today}</p>
                    <p style="margin: 5px 0;"><strong>ë‹´ë‹¹ì˜:</strong> ${doctorName}</p>
                </div>
            `;
            
            document.getElementById('interpretation-content').innerHTML = title + formattedContent;
        }

        // ë³´ê³ ì„œ ë‚´ìš© í¬ë§·íŒ… í•¨ìˆ˜
        function formatReportContent(content) {
            if (!content) return '';
            
            // ** ë¬¸ìì—´ ì œê±°
            let formattedContent = content.replace(/\*\*/g, '');
            
            // ë²ˆí˜¸ê°€ ìˆëŠ” ì„¹ì…˜ì„ ì°¾ì•„ì„œ ì¤„ë°”ê¿ˆê³¼ êµµì€ ê¸€ì”¨ ì ìš©
            // íŒ¨í„´: ìˆ«ì.ê³µë°±+í•œê¸€/ì˜ë¬¸ ì œëª© í˜•íƒœë§Œ ì²˜ë¦¬ (ë‚ ì§œ ì œì™¸)
            formattedContent = formattedContent.replace(/(\d+\.\s*[ê°€-í£a-zA-Z][^\n]*)/g, function(match) {
                // ë‚ ì§œ íŒ¨í„´ì´ í¬í•¨ëœ ê²½ìš°ëŠ” ì œì™¸ (2025-06- ê°™ì€ íŒ¨í„´)
                if (match.includes('2025-') || match.includes('ê²€ì‚¬ì¼:') || /\d{4}-\d{1,2}-\d{0,2}/.test(match)) {
                    return match; // ì›ë³¸ ê·¸ëŒ€ë¡œ ë°˜í™˜
                }
                // ì•ì— ì¤„ë°”ê¿ˆì„ ì¶”ê°€í•˜ê³  êµµì€ ê¸€ì”¨ë¡œ ë§Œë“¤ê¸°
                return '<br><br><strong>' + match.trim() + '</strong>';
            });
            
            // ì²« ë²ˆì§¸ í•­ëª© ì•ì˜ ë¶ˆí•„ìš”í•œ <br> ì œê±°
            formattedContent = formattedContent.replace(/^<br><br>/, '');
            
            // ì¼ë°˜ ì¤„ë°”ê¿ˆ ì²˜ë¦¬
            formattedContent = formattedContent.replace(/\n/g, '<br>');
            
            return formattedContent;
        }

        // ì›ë³¸ ì‘ë‹µ ëª¨ë‹¬ ê´€ë ¨ í•¨ìˆ˜ë“¤
        function showResponsesModal(sessionId) {
            const modal = document.getElementById('responses-modal');
            modal.style.display = 'block';
            loadResponses(sessionId);
        }

        async function loadResponses(sessionId) {
            try {
                const response = await fetch(`/sct/session/${sessionId}`);
                const data = await response.json();
                
                const responsesContent = document.getElementById('responses-content');
                responsesContent.innerHTML = `
                    <h2>${data.patient_name}ë‹˜ì˜ SCT ì‘ë‹µ</h2>
                    <p>ê²€ì‚¬ì¼: ${new Date(data.created_at).toLocaleDateString()}</p>
                    <div class="responses-list">
                        ${data.responses.map((resp, index) => `
                            <div class="response-item">
                                <h3>${index + 1}. ${resp.stem}</h3>
                                <p>${resp.answer}</p>
                            </div>
                        `).join('')}
                    </div>
                `;
            } catch (error) {
                console.error('ì‘ë‹µ ë¡œë”© ì‹¤íŒ¨:', error);
                alert('ì‘ë‹µì„ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
            }
        }

        function downloadResponsesPDF() {
            const content = document.getElementById('responses-content').innerHTML;
            const printWindow = window.open('', '_blank');
            
            printWindow.document.write(`
                <html>
                    <head>
                        <title>SCT ì›ë³¸ ì‘ë‹µ</title>
                        <style>
                    body {
                                font-family: Arial, sans-serif;
                                line-height: 1.6;
                                padding: 20px;
                            }
                            .response-item {
                                margin-bottom: 20px;
                                padding: 15px;
                                border: 1px solid #eee;
                                border-radius: 4px;
                            }
                            h2 {
                                color: #333;
                                margin-bottom: 10px;
                            }
                            h3 {
                                color: #444;
                                margin: 0 0 10px 0;
                            }
                            p {
                                margin: 0;
                                color: #666;
                }
            </style>
        </head>
        <body>
                        ${content}
        </body>
        </html>
            `);
            
            printWindow.document.close();
            printWindow.print();
        }

        function printResponses() {
            window.print();
        }

        // ëª¨ë‹¬ ì™¸ë¶€ í´ë¦­ ì‹œ ë‹«ê¸°
        window.onclick = function(event) {
            if (event.target.className === 'modal') {
                event.target.style.display = 'none';
            }
        }

        // í† ìŠ¤íŠ¸ ë©”ì‹œì§€ í‘œì‹œ í•¨ìˆ˜
        function showToast(type, message) {
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.textContent = message;
            
            // ê¸°ì¡´ í† ìŠ¤íŠ¸ ì œê±°
            const existingToast = document.querySelector('.toast');
            if (existingToast) {
                existingToast.remove();
            }
            
            document.body.appendChild(toast);
            
            // 3ì´ˆ í›„ ìë™ ì œê±°
            setTimeout(() => {
                toast.remove();
            }, 3000);
        }
    </script>
</body>
</html>