<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SCT ì„¸ì…˜ ìƒì„± ë””ë²„ê¹…</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
            color: #333;
            background: #f5f7fa;
            padding: 20px;
        }
        
        .container {
            max-width: 800px;
            margin: 0 auto;
        }
        
        .card {
            background: white;
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.08);
            margin-bottom: 25px;
        }
        
        .debug-section {
            background: #f8f9fa;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 15px;
            margin: 10px 0;
            font-family: monospace;
            font-size: 0.9em;
        }
        
        .success { color: #22543d; background: #c6f6d5; }
        .error { color: #c53030; background: #fed7d7; }
        .warning { color: #744210; background: #faf089; }
        .info { color: #2b6cb0; background: #bee3f8; }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-input {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 1em;
        }
        
        .button {
            background: linear-gradient(135deg, #4299e1, #667eea);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 8px;
            font-size: 1em;
            cursor: pointer;
            margin: 5px;
        }
        
        .button:hover {
            opacity: 0.9;
        }
        
        .button-secondary {
            background: #e2e8f0;
            color: #4a5568;
        }
        
        #debug-log {
            max-height: 400px;
            overflow-y: auto;
            white-space: pre-wrap;
        }
        
        .step {
            margin: 10px 0;
            padding: 10px;
            border-left: 4px solid #4299e1;
            background: #f7fafc;
        }
        
        .step.completed {
            border-left-color: #38a169;
            background: #f0fff4;
        }
        
        .step.error {
            border-left-color: #e53e3e;
            background: #fff5f5;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="card">
            <h1>ğŸ” SCT ì„¸ì…˜ ìƒì„± ë””ë²„ê¹… ë„êµ¬</h1>
            <p>ì´ ë„êµ¬ë¡œ ì„¸ì…˜ ìƒì„± ê³¼ì •ì˜ ê° ë‹¨ê³„ë¥¼ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
        </div>

        <!-- 1ë‹¨ê³„: í™˜ê²½ í™•ì¸ -->
        <div class="card">
            <h2>1ï¸âƒ£ í™˜ê²½ ì„¤ì • í™•ì¸</h2>
            <button onclick="checkEnvironment()" class="button">í™˜ê²½ ìƒíƒœ í™•ì¸</button>
            <div id="env-status" class="debug-section"></div>
        </div>

        <!-- 2ë‹¨ê³„: API ì—°ê²° í…ŒìŠ¤íŠ¸ -->
        <div class="card">
            <h2>2ï¸âƒ£ API ì„œë²„ ì—°ê²° í…ŒìŠ¤íŠ¸</h2>
            <button onclick="testApiConnection()" class="button">API ì—°ê²° í™•ì¸</button>
            <div id="api-status" class="debug-section"></div>
        </div>

        <!-- 3ë‹¨ê³„: ì¸ì¦ í† í° í™•ì¸ -->
        <div class="card">
            <h2>3ï¸âƒ£ ì¸ì¦ í† í° í™•ì¸</h2>
            <button onclick="checkAuthToken()" class="button">í† í° ìƒíƒœ í™•ì¸</button>
            <div id="token-status" class="debug-section"></div>
        </div>

        <!-- 4ë‹¨ê³„: ì„¸ì…˜ ìƒì„± ì‹œë®¬ë ˆì´ì…˜ -->
        <div class="card">
            <h2>4ï¸âƒ£ ì„¸ì…˜ ìƒì„± ì‹œë®¬ë ˆì´ì…˜</h2>
            <div class="form-group">
                <label>í…ŒìŠ¤íŠ¸ìš© í™˜ì ì´ë¦„:</label>
                <input type="text" id="test-patient-name" class="form-input" value="í…ŒìŠ¤íŠ¸í™˜ì" placeholder="í™˜ì ì´ë¦„ ì…ë ¥">
            </div>
            <button onclick="simulateSessionCreation()" class="button">ì„¸ì…˜ ìƒì„± í…ŒìŠ¤íŠ¸</button>
            <div id="session-test" class="debug-section"></div>
        </div>

        <!-- 5ë‹¨ê³„: ì „ì²´ ë””ë²„ê·¸ ë¡œê·¸ -->
        <div class="card">
            <h2>5ï¸âƒ£ ìƒì„¸ ë””ë²„ê·¸ ë¡œê·¸</h2>
            <button onclick="clearLog()" class="button button-secondary">ë¡œê·¸ ì§€ìš°ê¸°</button>
            <div id="debug-log" class="debug-section"></div>
        </div>

        <!-- í•´ê²°ì±… ì œì•ˆ -->
        <div class="card">
            <h2>ğŸ› ï¸ ë¬¸ì œ í•´ê²° ê°€ì´ë“œ</h2>
            <div id="solution-guide">
                <div class="step">
                    <strong>Step 1:</strong> ìœ„ì˜ "í™˜ê²½ ìƒíƒœ í™•ì¸" ë²„íŠ¼ì„ ëˆŒëŸ¬ ê¸°ë³¸ ì„¤ì •ì„ í™•ì¸í•˜ì„¸ìš”.
                </div>
                <div class="step">
                    <strong>Step 2:</strong> "API ì—°ê²° í™•ì¸" ë²„íŠ¼ìœ¼ë¡œ ì„œë²„ ì—°ê²° ìƒíƒœë¥¼ í™•ì¸í•˜ì„¸ìš”.
                </div>
                <div class="step">
                    <strong>Step 3:</strong> "í† í° ìƒíƒœ í™•ì¸" ë²„íŠ¼ìœ¼ë¡œ ë¡œê·¸ì¸ ìƒíƒœë¥¼ í™•ì¸í•˜ì„¸ìš”.
                </div>
                <div class="step">
                    <strong>Step 4:</strong> "ì„¸ì…˜ ìƒì„± í…ŒìŠ¤íŠ¸"ë¡œ ì‹¤ì œ API í˜¸ì¶œì„ ì‹œë®¬ë ˆì´ì…˜í•˜ì„¸ìš”.
                </div>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = 'https://sct-backend-7epf.onrender.com';
        
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logElement = document.getElementById('debug-log');
            const colorClass = type === 'error' ? 'error' : type === 'success' ? 'success' : type === 'warning' ? 'warning' : 'info';
            
            logElement.innerHTML += `<div class="${colorClass}">[${timestamp}] ${message}</div>\n`;
            logElement.scrollTop = logElement.scrollHeight;
            
            console.log(`[DEBUG] ${message}`);
        }

        function clearLog() {
            document.getElementById('debug-log').innerHTML = '';
        }

        // 1ë‹¨ê³„: í™˜ê²½ í™•ì¸
        function checkEnvironment() {
            const statusDiv = document.getElementById('env-status');
            let status = '';
            let allGood = true;

            log('í™˜ê²½ ì„¤ì • í™•ì¸ ì‹œì‘', 'info');

            // localStorage í™•ì¸
            const currentUser = localStorage.getItem('currentUser');
            const accessToken = localStorage.getItem('access_token');

            if (currentUser) {
                try {
                    const userData = JSON.parse(currentUser);
                    status += `âœ… ì‚¬ìš©ì ì •ë³´: ${userData.name} (${userData.doctorId})\n`;
                    log(`ì‚¬ìš©ì ì •ë³´ í™•ì¸ë¨: ${userData.name}`, 'success');
                } catch (e) {
                    status += `âŒ ì‚¬ìš©ì ì •ë³´ íŒŒì‹± ì˜¤ë¥˜: ${e.message}\n`;
                    log(`ì‚¬ìš©ì ì •ë³´ íŒŒì‹± ì˜¤ë¥˜: ${e.message}`, 'error');
                    allGood = false;
                }
            } else {
                status += `âŒ ì‚¬ìš©ì ì •ë³´ ì—†ìŒ (ë¡œê·¸ì¸ í•„ìš”)\n`;
                log('ì‚¬ìš©ì ì •ë³´ ì—†ìŒ', 'error');
                allGood = false;
            }

            if (accessToken) {
                status += `âœ… ì•¡ì„¸ìŠ¤ í† í°: ${accessToken.substring(0, 20)}...\n`;
                log('ì•¡ì„¸ìŠ¤ í† í° í™•ì¸ë¨', 'success');
            } else {
                status += `âŒ ì•¡ì„¸ìŠ¤ í† í° ì—†ìŒ\n`;
                log('ì•¡ì„¸ìŠ¤ í† í° ì—†ìŒ', 'error');
                allGood = false;
            }

            // API URL í™•ì¸
            status += `ğŸŒ API ì„œë²„: ${API_BASE}\n`;
            log(`API ì„œë²„ URL: ${API_BASE}`, 'info');

            // ë¸Œë¼ìš°ì € ê¸°ëŠ¥ í™•ì¸
            if (typeof fetch !== 'undefined') {
                status += `âœ… Fetch API ì§€ì›ë¨\n`;
                log('Fetch API ì§€ì› í™•ì¸', 'success');
            } else {
                status += `âŒ Fetch API ë¯¸ì§€ì›\n`;
                log('Fetch API ë¯¸ì§€ì›', 'error');
                allGood = false;
            }

            statusDiv.innerHTML = status;
            statusDiv.className = `debug-section ${allGood ? 'success' : 'error'}`;

            return allGood;
        }

        // 2ë‹¨ê³„: API ì—°ê²° í…ŒìŠ¤íŠ¸
        async function testApiConnection() {
            const statusDiv = document.getElementById('api-status');
            let status = '';

            log('API ì„œë²„ ì—°ê²° í…ŒìŠ¤íŠ¸ ì‹œì‘', 'info');

            try {
                statusDiv.innerHTML = 'ğŸ”„ API ì„œë²„ ì—°ê²° í™•ì¸ ì¤‘...';
                statusDiv.className = 'debug-section info';

                const response = await fetch(`${API_BASE}/health`, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });

                log(`API ì‘ë‹µ ìƒíƒœ: ${response.status}`, 'info');

                if (response.ok) {
                    const data = await response.text();
                    status += `âœ… API ì„œë²„ ì—°ê²° ì„±ê³µ\n`;
                    status += `ğŸ“¡ ì‘ë‹µ ì½”ë“œ: ${response.status}\n`;
                    status += `ğŸ“ ì‘ë‹µ ë‚´ìš©: ${data}\n`;
                    log('API ì„œë²„ ì—°ê²° ì„±ê³µ', 'success');
                    statusDiv.className = 'debug-section success';
                } else {
                    status += `âš ï¸ API ì„œë²„ ì‘ë‹µ ì´ìƒ\n`;
                    status += `ğŸ“¡ ì‘ë‹µ ì½”ë“œ: ${response.status}\n`;
                    status += `ğŸ“ ì‘ë‹µ í…ìŠ¤íŠ¸: ${response.statusText}\n`;
                    log(`API ì„œë²„ ì‘ë‹µ ì´ìƒ: ${response.status}`, 'warning');
                    statusDiv.className = 'debug-section warning';
                }

            } catch (error) {
                status += `âŒ API ì„œë²„ ì—°ê²° ì‹¤íŒ¨\n`;
                status += `ğŸ’¥ ì˜¤ë¥˜: ${error.message}\n`;
                log(`API ì„œë²„ ì—°ê²° ì‹¤íŒ¨: ${error.message}`, 'error');
                statusDiv.className = 'debug-section error';
            }

            statusDiv.innerHTML = status;
        }

        // 3ë‹¨ê³„: ì¸ì¦ í† í° í™•ì¸
        async function checkAuthToken() {
            const statusDiv = document.getElementById('token-status');
            let status = '';

            log('ì¸ì¦ í† í° ìœ íš¨ì„± í™•ì¸ ì‹œì‘', 'info');

            const token = localStorage.getItem('access_token');
            if (!token) {
                status = 'âŒ ì•¡ì„¸ìŠ¤ í† í°ì´ ì—†ìŠµë‹ˆë‹¤. ë‹¤ì‹œ ë¡œê·¸ì¸í•´ì£¼ì„¸ìš”.';
                statusDiv.innerHTML = status;
                statusDiv.className = 'debug-section error';
                log('ì•¡ì„¸ìŠ¤ í† í° ì—†ìŒ', 'error');
                return;
            }

            try {
                statusDiv.innerHTML = 'ğŸ”„ í† í° ìœ íš¨ì„± í™•ì¸ ì¤‘...';
                statusDiv.className = 'debug-section info';

                // ì‚¬ìš©ì ì •ë³´ë¡œ í† í° ìœ íš¨ì„± í™•ì¸
                const currentUser = localStorage.getItem('currentUser');
                const userData = JSON.parse(currentUser);
                
                const response = await fetch(`${API_BASE}/sct/sessions/by-user/${userData.doctorId}`, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    }
                });

                log(`í† í° ê²€ì¦ ì‘ë‹µ: ${response.status}`, 'info');

                if (response.status === 401) {
                    status += `âŒ í† í°ì´ ë§Œë£Œë˜ì—ˆìŠµë‹ˆë‹¤\n`;
                    status += `ğŸ”„ ë‹¤ì‹œ ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤\n`;
                    log('í† í° ë§Œë£Œë¨', 'error');
                    statusDiv.className = 'debug-section error';
                } else if (response.ok) {
                    status += `âœ… í† í°ì´ ìœ íš¨í•©ë‹ˆë‹¤\n`;
                    status += `ğŸ‘¤ ì‚¬ìš©ì: ${userData.doctorId}\n`;
                    log('í† í° ìœ íš¨ì„± í™•ì¸ë¨', 'success');
                    statusDiv.className = 'debug-section success';
                } else {
                    status += `âš ï¸ í† í° ê²€ì¦ ì¤‘ ì˜ˆìƒì¹˜ ëª»í•œ ì‘ë‹µ\n`;
                    status += `ğŸ“¡ ìƒíƒœ ì½”ë“œ: ${response.status}\n`;
                    log(`ì˜ˆìƒì¹˜ ëª»í•œ ì‘ë‹µ: ${response.status}`, 'warning');
                    statusDiv.className = 'debug-section warning';
                }

            } catch (error) {
                status += `âŒ í† í° ê²€ì¦ ì¤‘ ì˜¤ë¥˜ ë°œìƒ\n`;
                status += `ğŸ’¥ ì˜¤ë¥˜: ${error.message}\n`;
                log(`í† í° ê²€ì¦ ì˜¤ë¥˜: ${error.message}`, 'error');
                statusDiv.className = 'debug-section error';
            }

            statusDiv.innerHTML = status;
        }

        // 4ë‹¨ê³„: ì„¸ì…˜ ìƒì„± ì‹œë®¬ë ˆì´ì…˜
        async function simulateSessionCreation() {
            const statusDiv = document.getElementById('session-test');
            const patientName = document.getElementById('test-patient-name').value.trim();
            let status = '';

            if (!patientName) {
                status = 'âŒ í™˜ì ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.';
                statusDiv.innerHTML = status;
                statusDiv.className = 'debug-section error';
                return;
            }

            log(`ì„¸ì…˜ ìƒì„± ì‹œë®¬ë ˆì´ì…˜ ì‹œì‘: ${patientName}`, 'info');

            const token = localStorage.getItem('access_token');
            const currentUser = localStorage.getItem('currentUser');

            if (!token || !currentUser) {
                status = 'âŒ ë¡œê·¸ì¸ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤. ë¨¼ì € ë¡œê·¸ì¸í•´ì£¼ì„¸ìš”.';
                statusDiv.innerHTML = status;
                statusDiv.className = 'debug-section error';
                log('ë¡œê·¸ì¸ ì •ë³´ ì—†ìŒ', 'error');
                return;
            }

            try {
                statusDiv.innerHTML = 'ğŸ”„ ì„¸ì…˜ ìƒì„± ìš”ì²­ ì¤‘...';
                statusDiv.className = 'debug-section info';

                const userData = JSON.parse(currentUser);
                const requestBody = {
                    patient_name: patientName,
                    assigned_by: userData.doctorId
                };

                log(`ìš”ì²­ ë°ì´í„°: ${JSON.stringify(requestBody)}`, 'info');

                const response = await fetch(`${API_BASE}/sct/sessions`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify(requestBody)
                });

                log(`ì„¸ì…˜ ìƒì„± ì‘ë‹µ ìƒíƒœ: ${response.status}`, 'info');

                if (response.ok) {
                    const sessionData = await response.json();
                    status += `âœ… ì„¸ì…˜ ìƒì„± ì„±ê³µ!\n`;
                    status += `ğŸ†” ì„¸ì…˜ ID: ${sessionData.session_id}\n`;
                    status += `ğŸ‘¤ í™˜ìëª…: ${sessionData.patient_name}\n`;
                    status += `ğŸ”— í™˜ì ë§í¬: ${window.location.origin}/patient.html?session=${sessionData.session_id}\n`;
                    
                    log('ì„¸ì…˜ ìƒì„± ì„±ê³µ', 'success');
                    log(`ìƒì„±ëœ ì„¸ì…˜ ID: ${sessionData.session_id}`, 'success');
                    statusDiv.className = 'debug-section success';

                } else {
                    const errorText = await response.text();
                    let errorData;
                    try {
                        errorData = JSON.parse(errorText);
                    } catch (e) {
                        errorData = { detail: errorText };
                    }

                    status += `âŒ ì„¸ì…˜ ìƒì„± ì‹¤íŒ¨\n`;
                    status += `ğŸ“¡ ìƒíƒœ ì½”ë“œ: ${response.status}\n`;
                    status += `ğŸ’¥ ì˜¤ë¥˜ ë©”ì‹œì§€: ${errorData.detail || errorText}\n`;
                    
                    log(`ì„¸ì…˜ ìƒì„± ì‹¤íŒ¨: ${response.status}`, 'error');
                    log(`ì˜¤ë¥˜ ë‚´ìš©: ${errorData.detail || errorText}`, 'error');
                    statusDiv.className = 'debug-section error';
                }

            } catch (error) {
                status += `âŒ ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜\n`;
                status += `ğŸ’¥ ì˜¤ë¥˜: ${error.message}\n`;
                log(`ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜: ${error.message}`, 'error');
                statusDiv.className = 'debug-section error';
            }

            statusDiv.innerHTML = status;
        }

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ìë™ìœ¼ë¡œ ê¸°ë³¸ í™•ì¸ ì‹¤í–‰
        window.addEventListener('load', function() {
            log('ë””ë²„ê¹… ë„êµ¬ ì‹œì‘', 'info');
            setTimeout(() => {
                checkEnvironment();
            }, 500);
        });
    </script>
</body>
</html>