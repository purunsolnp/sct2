<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SCT ê´€ë¦¬ì í˜ì´ì§€</title>
    <!-- Toastify CSS -->
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css">
    <!-- Toastify JS -->
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/toastify-js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f5f7fa;
            color: #333;
            margin: 0;
            padding: 0;
        }
        .header {
            background: #f7fafc;
            padding: 20px 0 10px 0;
            border-bottom: 1px solid #e2e8f0;
            margin-bottom: 20px;
        }
        .header-content {
            display: flex;
            align-items: center;
            justify-content: space-between;
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
        }
        .button {
            background: linear-gradient(135deg, #4299e1, #667eea);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9em;
            transition: all 0.3s ease;
        }
        .button:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(66, 153, 225, 0.3);
        }
        .button-secondary {
            background: #e2e8f0;
            color: #4a5568;
            border: 2px solid #cbd5e0;
        }
        .button-secondary:hover {
            background: #cbd5e0;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        .button-primary {
            background: linear-gradient(135deg, #4299e1, #667eea);
        }
        .button-danger {
            background: #e53e3e;
        }
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 18px;
            margin-bottom: 30px;
        }
        .stat-card {
            background: white;
            padding: 18px;
            border-radius: 10px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.04);
            text-align: center;
        }
        .stat-number {
            font-size: 2.5em;
            font-weight: bold;
            color: #4299e1;
            margin-bottom: 5px;
        }
        .stat-label {
            color: #718096;
            font-size: 0.9em;
            text-transform: uppercase;
            font-weight: 600;
        }
        .card {
            background: white;
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.08);
            margin-bottom: 25px;
        }
        .card-header {
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #e2e8f0;
        }
        .card-body {
            padding: 0;
        }
        .form-input, .form-control {
            padding: 8px 12px;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            font-size: 0.9em;
        }
        .search-input {
            flex: 1;
            padding: 8px 12px;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
        }
        .data-table, .table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }
        .data-table th, .data-table td,
        .table th, .table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #e2e8f0;
        }
        .data-table th, .table th {
            background: #f7fafc;
            font-weight: 600;
            color: #2d3748;
        }
        .data-table tr:hover, .table tr:hover {
            background: #f7fafc;
        }
        .table-striped tbody tr:nth-of-type(odd) {
            background-color: rgba(0,0,0,.05);
        }
        .table-responsive {
            overflow-x: auto;
        }
        .status-toggle {
            position: relative;
            display: inline-block;
            width: 40px;
            height: 22px;
        }
        .status-toggle input {
            display: none;
        }
        .status-toggle .slider {
            position: absolute;
            cursor: pointer;
            top: 0; left: 0; right: 0; bottom: 0;
            background-color: #ccc;
            border-radius: 22px;
            transition: .4s;
        }
        .status-toggle input:checked + .slider {
            background-color: #38a169;
        }
        .status-toggle .slider:before {
            position: absolute;
            content: "";
            height: 16px;
            width: 16px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            border-radius: 50%;
            transition: .4s;
        }
        .status-toggle input:checked + .slider:before {
            transform: translateX(18px);
        }
        .loading {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 40px;
            color: #718096;
        }
        .loading-spinner {
            width: 20px;
            height: 20px;
            border: 2px solid #e2e8f0;
            border-top: 2px solid #4299e1;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 10px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .pagination {
            display: flex;
            justify-content: center;
            gap: 5px;
            margin: 20px 0;
        }
        .pagination button {
            padding: 8px 12px;
            border: 1px solid #e2e8f0;
            background: white;
            cursor: pointer;
            border-radius: 4px;
        }
        .pagination button:hover {
            background: #f7fafc;
        }
        .pagination button.active {
            background: #4299e1;
            color: white;
            border-color: #4299e1;
        }
        .pagination button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        .search-controls {
            display: flex;
            gap: 10px;
            margin: 15px 0;
            align-items: center;
        }
        .filter-controls {
            display: flex;
            gap: 10px;
            margin: 20px 0;
            align-items: center;
        }
        .log-entry {
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 10px;
        }
        .log-timestamp {
            font-size: 0.85em;
            color: #718096;
            margin-bottom: 5px;
        }
        .log-message {
            color: #2d3748;
            font-weight: 500;
        }
        .log-details {
            font-size: 0.9em;
            color: #4a5568;
            margin-top: 8px;
            padding: 8px;
            background: #f7fafc;
            border-radius: 4px;
        }
        .alert {
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
        }
        .alert-success {
            background: #c6f6d5;
            border: 1px solid #9ae6b4;
            color: #22543d;
        }
        .alert-error {
            background: #fed7d7;
            border: 1px solid #feb2b2;
            color: #742a2a;
        }
        .badge {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.8em;
            font-weight: 500;
        }
        .bg-success {
            background-color: #38a169;
            color: white;
        }
        .bg-danger {
            background-color: #e53e3e;
            color: white;
        }
        .nav-tabs {
            display: flex;
            border-bottom: 1px solid #e2e8f0;
            margin-bottom: 20px;
        }
        .nav-item {
            list-style: none;
        }
        .nav-link {
            display: block;
            padding: 10px 20px;
            text-decoration: none;
            color: #4a5568;
            border-bottom: 2px solid transparent;
        }
        .nav-link.active {
            color: #4299e1;
            border-bottom-color: #4299e1;
        }
        .tab-content {
            margin-top: 20px;
        }
        .tab-pane {
            display: none;
        }
        .tab-pane.show.active {
            display: block;
        }
        .row {
            display: flex;
            flex-wrap: wrap;
            margin: 0 -15px;
        }
        .col-md-6 {
            flex: 0 0 50%;
            max-width: 50%;
            padding: 0 15px;
        }
        .mb-3 {
            margin-bottom: 1rem;
        }
        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: #4a5568;
        }
        .form-text {
            font-size: 0.85em;
            color: #718096;
            margin-top: 4px;
        }
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9em;
            transition: all 0.3s ease;
        }
        .btn-primary {
            background: #4299e1;
            color: white;
        }
        .btn-primary:hover {
            background: #3182ce;
        }
        .mb-0 {
            margin-bottom: 0;
        }
        .mb-4 {
            margin-bottom: 2rem;
        }
        .mt-3 {
            margin-top: 1rem;
        }
    </style>
</head>
<body>
    <!-- ê´€ë¦¬ì ì •ë³´ ë° ëŒ€ì‹œë³´ë“œ í†µê³„ -->
    <div class="header">
        <div class="header-content">
            <div style="font-size: 1.2em; font-weight: 600; color: #2d3748;">
                ğŸ¥ <span>ê´€ë¦¬ì ID: <span id="admin-id">-</span></span>
                <span style="margin-left: 20px;">ì´ë¦„: <span id="admin-name">-</span></span>
            </div>
            <button onclick="logout()" class="button button-secondary" style="height: 40px;">ğŸšª ë¡œê·¸ì•„ì›ƒ</button>
        </div>
    </div>
    <div class="container">
        <!-- ëŒ€ì‹œë³´ë“œ í†µê³„ ì¹´ë“œ -->
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-number" id="total-users">-</div>
                <div class="stat-label">ì´ ì‚¬ìš©ì</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="total-sessions">-</div>
                <div class="stat-label">ì´ ì„¸ì…˜</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="month-sessions">-</div>
                <div class="stat-label">ì´ë²ˆë‹¬ ì„¸ì…˜</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="pending-sessions">-</div>
                <div class="stat-label">ëŒ€ê¸°ì¤‘ ì„¸ì…˜</div>
            </div>
        </div>

        <!-- ê´€ë¦¬ì ì„¸ì…˜ ìƒì„± í¼ -->
        <div class="card">
            <h2>ğŸ†• ê´€ë¦¬ì ì„¸ì…˜ ìƒì„±</h2>
            <form id="admin-create-session-form" style="display: flex; gap: 10px; align-items: center;">
                <input id="admin-patient-name" type="text" placeholder="í™˜ì ì´ë¦„" style="padding: 6px 10px; border-radius: 6px; border: 1px solid #ccc;">
                <select id="admin-doctor-select" style="padding: 6px 10px; border-radius: 6px; border: 1px solid #ccc; min-width: 180px;">
                    <option value="">ë‹´ë‹¹ ì˜ì‚¬ë¥¼ ì„ íƒí•˜ì„¸ìš”</option>
                </select>
                <button type="submit" class="button button-primary">ì„¸ì…˜ ìƒì„±</button>
            </form>
            <div id="admin-session-alert" class="alert alert-success" style="display: none;">
                <strong>âœ… ìƒˆ ê²€ì‚¬ê°€ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤!</strong>
                <div style="margin-top: 10px;">
                    <p><strong>í™˜ìì—ê²Œ ì „ë‹¬í•  ê²€ì‚¬ ë§í¬:</strong></p>
                    <div id="admin-patient-link" style="background: #f7fafc; padding: 10px; border-radius: 4px; margin: 10px 0; word-break: break-all;"></div>
                    <button onclick="copyAdminLink()" class="button button-secondary">ğŸ“‹ ë§í¬ ë³µì‚¬</button>
                </div>
            </div>
        </div>

        <!-- ì „ì²´ ì´ìš©ì(ì˜ì‚¬) ì¹´ë“œ ë¦¬ìŠ¤íŠ¸ -->
        <div id="user-list" style="display: none;"></div>
        
        <!-- ì „ì²´ ì´ìš©ì(ì˜ì‚¬) í…Œì´ë¸” ë¦¬ìŠ¤íŠ¸ -->
        <div class="card">
            <h2>ğŸ‘¥ ì´ìš©ì ê´€ë¦¬</h2>
            <div id="user-stats-summary"></div>
            <table id="user-table" style="width:100%;border-collapse:collapse;background:#f7fafc;box-shadow:0 2px 8px rgba(0,0,0,0.04);border-radius:10px;overflow:hidden;">
                <thead style="background:#e2e8f0;">
                    <tr>
                        <th style="padding:10px;">ì´ë¦„</th>
                        <th style="padding:10px;">ì•„ì´ë””</th>
                        <th style="padding:10px;">ì´ë©”ì¼</th>
                        <th style="padding:10px;">ê¶Œí•œ</th>
                        <th style="padding:10px;">ìƒíƒœ</th>
                        <th style="padding:10px;">í†µê³„</th>
                        <th style="padding:10px;">ìŠ¹ì¸/ë¸”ë½</th>
                    </tr>
                </thead>
                <tbody id="user-table-body"></tbody>
            </table>
        </div>
        
        <!-- ì´ìš©ìë³„ í†µê³„ ì˜ì—­ -->
        <div id="user-detail-stats"></div>
        
        <!-- ì›”ë³„ ì°¨íŠ¸(ì „ì²´) -->
        <div style="background: #fff; border-radius: 10px; box-shadow: 0 2px 8px rgba(0,0,0,0.04); padding: 18px; margin-bottom: 24px;">
            <canvas id="monthlyChart" height="300"></canvas>
        </div>
        
        <!-- í†µê³„ ë¶€ê°€ ì •ë³´ -->
        <div style="display: flex; flex-wrap: wrap; gap: 20px; margin-bottom: 30px;">
            <div id="active-users-info" style="font-size: 1.05em; color: #2b6cb0; min-width: 180px;"></div>
            <div id="completion-rate" style="font-size: 1.05em; color: #38a169; min-width: 180px;"></div>
            <div id="month-completed" style="font-size: 1.05em; color: #4299e1; min-width: 180px;"></div>
            <div id="expired-sessions-info" style="font-size: 1.05em; color: #e53e3e; min-width: 180px;"></div>
        </div>
        
        <!-- ì‹œìŠ¤í…œ ë¡œê·¸ íƒ­ -->
        <div id="logs-tab" class="tab-content">
            <h2>ğŸ“‹ ì‹œìŠ¤í…œ ë¡œê·¸</h2>
            
            <div class="search-controls">
                <select id="log-level-filter" class="search-input" style="flex: 0 0 150px;">
                    <option value="">ëª¨ë“  ë ˆë²¨</option>
                    <option value="info">ì •ë³´</option>
                    <option value="warning">ê²½ê³ </option>
                    <option value="error">ì˜¤ë¥˜</option>
                </select>
                <button onclick="refreshLogs()" class="button button-secondary">ğŸ”„ ìƒˆë¡œê³ ì¹¨</button>
            </div>
            
            <div id="logs-loading" class="loading" style="display: none;">
                <div class="loading-spinner"></div>
                <p>ë¡œê·¸ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>
            </div>
            
            <div id="logs-container"></div>
            
            <div class="pagination" id="logs-pagination" style="display: none;">
                <button onclick="goToLogsPage(1)" id="logs-first-page"><<</button>
                <button onclick="goToLogsPage(currentLogsPage - 1)" id="logs-prev-page"><</button>
                <div id="logs-page-numbers"></div>
                <button onclick="goToLogsPage(currentLogsPage + 1)" id="logs-next-page">></button>
                <button onclick="goToLogsPage(totalLogsPages)" id="logs-last-page">>></button>
            </div>
        </div>
        
        <!-- ì‹œìŠ¤í…œ ê´€ë¦¬ íƒ­ -->
        <div id="maintenance-tab" class="tab-content">
            <h2>ğŸ”§ ì‹œìŠ¤í…œ ê´€ë¦¬</h2>
            
            <div style="display: grid; gap: 20px;">
                <div style="background: #f7fafc; padding: 20px; border-radius: 8px; border-left: 4px solid #4299e1;">
                    <h3>ğŸ—‘ï¸ ë°ì´í„°ë² ì´ìŠ¤ ì •ë¦¬</h3>
                    <p>ë§Œë£Œëœ ì˜¤ë˜ëœ ì„¸ì…˜ê³¼ ê´€ë ¨ ë°ì´í„°ë¥¼ ì •ë¦¬í•©ë‹ˆë‹¤.</p>
                    <div style="margin: 15px 0;">
                        <label for="cleanup-days">ì •ë¦¬ ê¸°ì¤€ (ì¼):</label>
                        <input type="number" id="cleanup-days" value="30" min="7" max="365" style="margin-left: 10px; padding: 5px; border: 1px solid #ccc; border-radius: 4px;">
                    </div>
                    <div style="display: flex; gap: 10px;">
                        <button onclick="simulateCleanup()" class="button button-secondary">ğŸ§ª ì‹œë®¬ë ˆì´ì…˜</button>
                        <button onclick="executeCleanup()" class="button button-danger">ğŸ—‘ï¸ ì‹¤í–‰</button>
                    </div>
                    <div id="cleanup-result" style="margin-top: 15px;"></div>
                </div>
                
                <div style="background: #fff3cd; padding: 20px; border-radius: 8px; border-left: 4px solid #ffd700;">
                    <h3>âš ï¸ ì‹œìŠ¤í…œ ìƒíƒœ</h3>
                    <div id="system-status">
                        <p>âœ… ë°ì´í„°ë² ì´ìŠ¤: ì—°ê²°ë¨</p>
                        <p>âœ… OpenAI API: ì •ìƒ</p>
                        <p>âœ… ë©”ëª¨ë¦¬ ì‚¬ìš©ëŸ‰: ì •ìƒ</p>
                    </div>
                    <button onclick="checkSystemHealth()" class="button button-secondary" style="margin-top: 10px;">ğŸ” ìƒíƒœ í™•ì¸</button>
                </div>
            </div>
        </div>
        
        <!-- GPT ì‚¬ìš©ëŸ‰ í†µê³„ -->
        <div class="card">
            <h2>ğŸ¤– GPT ì‚¬ìš©ëŸ‰ í†µê³„</h2>
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-number" id="total-tokens">0</div>
                    <div class="stat-label">ì´ í† í°</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="total-cost">$0.00</div>
                    <div class="stat-label">ì´ ë¹„ìš©</div>
                </div>
            </div>
            
            <!-- ë‚ ì§œ í•„í„° -->
            <div class="filter-controls" style="margin: 20px 0;">
                <input type="date" id="gpt-start-date" class="form-input">
                <input type="date" id="gpt-end-date" class="form-input">
                <button onclick="loadGPTUsage()" class="button">ì¡°íšŒ</button>
            </div>
            
            <!-- ì˜ì‚¬ë³„ ì‚¬ìš©ëŸ‰ -->
            <h3>ì˜ì‚¬ë³„ ì‚¬ìš©ëŸ‰</h3>
            <table class="data-table">
                <thead>
                    <tr>
                        <th>ì˜ì‚¬ ID</th>
                        <th>ì‚¬ìš© íšŸìˆ˜</th>
                        <th>ì´ í† í°</th>
                        <th>ì´ ë¹„ìš©</th>
                    </tr>
                </thead>
                <tbody id="gpt-doctor-stats">
                </tbody>
            </table>
            
            <!-- ëª¨ë¸ë³„ ì‚¬ìš©ëŸ‰ -->
            <h3>ëª¨ë¸ë³„ ì‚¬ìš©ëŸ‰</h3>
            <table class="data-table">
                <thead>
                    <tr>
                        <th>ëª¨ë¸</th>
                        <th>ì‚¬ìš© íšŸìˆ˜</th>
                        <th>ì´ í† í°</th>
                        <th>ì´ ë¹„ìš©</th>
                    </tr>
                </thead>
                <tbody id="gpt-model-stats">
                </tbody>
            </table>
        </div>
        
        <!-- ë³´ì•ˆ ëª¨ë‹ˆí„°ë§ ì„¹ì…˜ -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0">ğŸ”’ ë³´ì•ˆ ëª¨ë‹ˆí„°ë§</h5>
            </div>
            <div class="card-body">
                <ul class="nav nav-tabs" id="securityTabs" role="tablist">
                    <li class="nav-item">
                        <a class="nav-link active" id="login-attempts-tab" data-bs-toggle="tab" href="#login-attempts" role="tab">
                            ë¡œê·¸ì¸ ì‹œë„ ê¸°ë¡
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" id="ip-blocks-tab" data-bs-toggle="tab" href="#ip-blocks" role="tab">
                            IP ì°¨ë‹¨ ëª©ë¡
                        </a>
                    </li>
                </ul>
                
                <div class="tab-content mt-3" id="securityTabContent">
                    <!-- ë¡œê·¸ì¸ ì‹œë„ ê¸°ë¡ -->
                    <div class="tab-pane fade show active" id="login-attempts" role="tabpanel">
                        <div class="table-responsive">
                            <table class="table table-striped">
                                <thead>
                                    <tr>
                                        <th>ì‹œê°„</th>
                                        <th>IP ì£¼ì†Œ</th>
                                        <th>ì˜ì‚¬ ID</th>
                                        <th>ìƒíƒœ</th>
                                        <th>User Agent</th>
                                    </tr>
                                </thead>
                                <tbody id="loginAttemptsTable">
                                    <!-- ë¡œê·¸ì¸ ì‹œë„ ê¸°ë¡ì´ ì—¬ê¸°ì— ë™ì ìœ¼ë¡œ ì¶”ê°€ë©ë‹ˆë‹¤ -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                    
                    <!-- IP ì°¨ë‹¨ ëª©ë¡ -->
                    <div class="tab-pane fade" id="ip-blocks" role="tabpanel">
                        <div class="table-responsive">
                            <table class="table table-striped">
                                <thead>
                                    <tr>
                                        <th>IP ì£¼ì†Œ</th>
                                        <th>ì‹œë„ íšŸìˆ˜</th>
                                        <th>ë§ˆì§€ë§‰ ì‹œë„</th>
                                        <th>ì°¨ë‹¨ í•´ì œ ì‹œê°„</th>
                                    </tr>
                                </thead>
                                <tbody id="ipBlocksTable">
                                    <!-- IP ì°¨ë‹¨ ëª©ë¡ì´ ì—¬ê¸°ì— ë™ì ìœ¼ë¡œ ì¶”ê°€ë©ë‹ˆë‹¤ -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- ì‹œìŠ¤í…œ ì„¤ì • ì„¹ì…˜ -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0">âš™ï¸ ì‹œìŠ¤í…œ ì„¤ì •</h5>
            </div>
            <div class="card-body">
                <form id="systemSettingsForm">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="maxConcurrentSessions" class="form-label">ìµœëŒ€ ë™ì‹œ ì„¸ì…˜ ìˆ˜</label>
                                <input type="number" class="form-control" id="maxConcurrentSessions" min="1" max="5">
                                <div class="form-text">ì‚¬ìš©ìë‹¹ í—ˆìš©ë˜ëŠ” ìµœëŒ€ ë™ì‹œ ì„¸ì…˜ ìˆ˜ (1-5)</div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="sessionTimeout" class="form-label">ì„¸ì…˜ íƒ€ì„ì•„ì›ƒ (ë¶„)</label>
                                <input type="number" class="form-control" id="sessionTimeout" min="5" max="120">
                                <div class="form-text">ì„¸ì…˜ ìë™ ì¢…ë£Œ ì‹œê°„ (5-120ë¶„)</div>
                            </div>
                        </div>
                    </div>
                    <button type="submit" class="btn btn-primary">ì„¤ì • ì €ì¥</button>
                </form>
            </div>
        </div>
    </div>

    <script>
        // === API ì„œë²„ ì£¼ì†Œë¥¼ ì—¬ê¸°ì— ì„¤ì •í•˜ì„¸ìš” ===
        const API_BASE = "https://sct-backend-7epf.onrender.com";
        // ======================================
        let adminId = '';
        let adminName = '';
        let currentUsersPage = 1;
        let totalUsersPages = 1;
        let currentLogsPage = 1;
        let totalLogsPages = 1;
        let monthlyChart = null;
        let usageChart = null;
        let currentAdminSessionLink = '';
        
        // ì˜ì‚¬ ëª©ë¡ ë¡œë”© í•¨ìˆ˜
        async function loadDoctorsList() {
            try {
                console.log('ì˜ì‚¬ ëª©ë¡ ë¡œë”© ì‹œì‘');
                
                const response = await fetch(`${API_BASE}/admin/users?limit=100`, {
                    headers: getApiHeaders()
                });
                
                if (!response.ok) {
                    throw new Error('ì˜ì‚¬ ëª©ë¡ ë¡œë“œ ì‹¤íŒ¨');
                }
                
                const data = await response.json();
                console.log('ì˜ì‚¬ ëª©ë¡ ë¡œë“œ ì„±ê³µ:', data);
                
                const doctorSelect = document.getElementById('admin-doctor-select');
                if (!doctorSelect) {
                    console.error('admin-doctor-select ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŒ');
                    return;
                }
                
                doctorSelect.innerHTML = '<option value="">ë‹´ë‹¹ ì˜ì‚¬ë¥¼ ì„ íƒí•˜ì„¸ìš”</option>';
                
                // ì¸ì¦ëœ ì˜ì‚¬ë“¤ë§Œ í•„í„°ë§
                const verifiedDoctors = data.users.filter(user => user.is_verified);
                
                verifiedDoctors.forEach(doctor => {
                    const option = document.createElement('option');
                    option.value = doctor.doctor_id;
                    option.textContent = `${doctor.name} (${doctor.doctor_id}) - ${doctor.specialty || 'ì „ë¬¸ê³¼ëª©'}`;
                    doctorSelect.appendChild(option);
                });
                
                console.log(`âœ… ${verifiedDoctors.length}ëª…ì˜ ì¸ì¦ëœ ì˜ì‚¬ ë¡œë“œ ì™„ë£Œ`);
                
            } catch (error) {
                console.error('ì˜ì‚¬ ëª©ë¡ ë¡œë“œ ì˜¤ë¥˜:', error);
                alert('ì˜ì‚¬ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•´ì£¼ì„¸ìš”.');
            }
        }
        
        // ê´€ë¦¬ììš© ì„¸ì…˜ ìƒì„± í•¨ìˆ˜
        async function handleAdminSessionCreate(event) {
            event.preventDefault();
            
            const patientName = document.getElementById('admin-patient-name').value.trim();
            const selectedDoctorId = document.getElementById('admin-doctor-select').value;
            
            console.log('ê´€ë¦¬ì ì„¸ì…˜ ìƒì„± ì‹œë„:', { patientName, selectedDoctorId });
            
            if (!patientName) {
                alert('í™˜ì ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return;
            }
            
            if (!selectedDoctorId) {
                alert('ë‹´ë‹¹ ì˜ì‚¬ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.');
                return;
            }
            
            try {
                const requestBody = {
                    patient_name: patientName,
                    assigned_by: selectedDoctorId
                };
                
                console.log('ì „ì†¡í•  ë°ì´í„°:', requestBody);
                
                const response = await fetch(`${API_BASE}/sct/sessions`, {
                    method: 'POST',
                    headers: getApiHeaders(),
                    body: JSON.stringify(requestBody)
                });
                
                console.log('ì„¸ì…˜ ìƒì„± ì‘ë‹µ ìƒíƒœ:', response.status);
                
                if (!response.ok) {
                    if (response.status === 401) {
                        alert('ë¡œê·¸ì¸ì´ ë§Œë£Œë˜ì—ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ë¡œê·¸ì¸í•´ì£¼ì„¸ìš”.');
                        localStorage.removeItem('access_token');
                        localStorage.removeItem('currentUser');
                        window.location.href = 'login.html';
                        return;
                    }
                    const errorData = await response.json();
                    console.error('ì„¸ì…˜ ìƒì„± ì˜¤ë¥˜:', errorData);
                    throw new Error(errorData.detail || 'ì„¸ì…˜ ìƒì„±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                }
                
                const sessionData = await response.json();
                console.log('ìƒì„±ëœ ì„¸ì…˜:', sessionData);
                
                // ì„±ê³µ ë©”ì‹œì§€ ë° ë§í¬ í‘œì‹œ
                const patientLink = `${window.location.origin}/patient.html?session=${sessionData.session_id}`;
                currentAdminSessionLink = patientLink;
                
                document.getElementById('admin-patient-link').textContent = patientLink;
                document.getElementById('admin-session-alert').style.display = 'block';
                
                // í¼ ì´ˆê¸°í™”
                document.getElementById('admin-patient-name').value = '';
                document.getElementById('admin-doctor-select').value = '';
                
                // ëŒ€ì‹œë³´ë“œ í†µê³„ ìƒˆë¡œê³ ì¹¨
                loadDashboardStats();
                
                console.log('âœ… ê´€ë¦¬ì ì„¸ì…˜ ìƒì„± ì™„ë£Œ');
                
            } catch (error) {
                console.error('ê´€ë¦¬ì ì„¸ì…˜ ìƒì„± ì˜¤ë¥˜:', error);
                alert('ì„¸ì…˜ ìƒì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
            }
        }
        
        // ê´€ë¦¬ììš© ë§í¬ ë³µì‚¬ í•¨ìˆ˜
        function copyAdminLink() {
            if (!currentAdminSessionLink) {
                alert('ë³µì‚¬í•  ë§í¬ê°€ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }
            
            navigator.clipboard.writeText(currentAdminSessionLink).then(() => {
                alert('ê²€ì‚¬ ë§í¬ê°€ í´ë¦½ë³´ë“œì— ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤!');
            }).catch(err => {
                console.error('ë§í¬ ë³µì‚¬ ì‹¤íŒ¨:', err);
                alert('ë§í¬ ë³µì‚¬ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ë§í¬ë¥¼ ì§ì ‘ ë³µì‚¬í•´ì£¼ì„¸ìš”.');
            });
        }
        
        // API í—¤ë”
        function getApiHeaders() {
            const token = localStorage.getItem('access_token');
            return {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${token}`
            };
        }
        
        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì‹¤í–‰
        document.addEventListener('DOMContentLoaded', function() {
            // ë¡œê·¸ì¸ í™•ì¸
            const currentUser = localStorage.getItem('currentUser');
            if (!currentUser) {
                alert('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.');
                window.location.href = 'login.html';
                return;
            }
            
            const userData = JSON.parse(currentUser);
            adminId = userData.doctorId;
            adminName = userData.name;
            
            // ê´€ë¦¬ì ê¶Œí•œ í™•ì¸ (ì„ì‹œ)
            if (!['admin', 'doctor1'].includes(adminId)) {
                alert('ê´€ë¦¬ì ê¶Œí•œì´ í•„ìš”í•©ë‹ˆë‹¤.');
                window.location.href = 'doctor.html';
                return;
            }
            
            document.getElementById('admin-id').textContent = adminId;
            document.getElementById('admin-name').textContent = adminName;
            
            // ì´ˆê¸° ë°ì´í„° ë¡œë“œ
            loadDashboardStats();
            loadMonthlyChart();
            loadDoctorsList();
            loadAllUsersAndRenderTable();
            
            // ê´€ë¦¬ì ì„¸ì…˜ ìƒì„± í¼ ì´ë²¤íŠ¸ ì—°ê²°
            const adminForm = document.getElementById('admin-create-session-form');
            if (adminForm) {
                adminForm.addEventListener('submit', handleAdminSessionCreate);
                console.log('âœ… ê´€ë¦¬ì ì„¸ì…˜ ìƒì„± í¼ ì´ë²¤íŠ¸ ì—°ê²°ë¨');
            } else {
                console.error('âŒ admin-create-session-form ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŒ');
            }
            
            // ê²€ìƒ‰ ì´ë²¤íŠ¸ ì„¤ì • (ìš”ì†Œê°€ ìˆì„ ë•Œë§Œ)
            const userSearch = document.getElementById('user-search');
            if (userSearch) {
                userSearch.addEventListener('input', debounce(searchUsers, 500));
            }
            
            const logLevelFilter = document.getElementById('log-level-filter');
            if (logLevelFilter) {
                logLevelFilter.addEventListener('change', refreshLogs);
            }
            
            // ì˜¤ëŠ˜ ë‚ ì§œë¥¼ ê¸°ë³¸ê°’ìœ¼ë¡œ ì„¤ì •
            const today = new Date().toISOString().split('T')[0];
            const gptStartDate = document.getElementById('gpt-start-date');
            const gptEndDate = document.getElementById('gpt-end-date');
            
            if (gptStartDate) gptStartDate.value = today;
            if (gptEndDate) gptEndDate.value = today;
            
            // GPT ì‚¬ìš©ëŸ‰ ë¡œë“œ
            loadGPTUsage();
            
            // ë³´ì•ˆ ë°ì´í„° ë¡œë“œ (ìš”ì†Œê°€ ìˆì„ ë•Œë§Œ)
            const loginAttemptsTable = document.getElementById('loginAttemptsTable');
            if (loginAttemptsTable) {
                loadSecurityData();
                // 1ë¶„ë§ˆë‹¤ ë³´ì•ˆ ë°ì´í„° ê°±ì‹ 
                setInterval(loadSecurityData, 60000);
            }
            
            // ì‹œìŠ¤í…œ ì„¤ì • ë¡œë“œ
            loadSystemSettings();
            
            // ì‹œìŠ¤í…œ ì„¤ì • í¼ ì´ë²¤íŠ¸ ì„¤ì •
            setupSystemSettingsForm();
        });
        
        // ë””ë°”ìš´ìŠ¤ í•¨ìˆ˜
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }
        
        // ë¡œê·¸ì•„ì›ƒ
        function logout() {
            if (confirm('ì •ë§ ë¡œê·¸ì•„ì›ƒ í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                localStorage.removeItem('currentUser');
                localStorage.removeItem('access_token');
                window.location.href = 'login.html';
            }
        }
        
        // íƒ­ ì „í™˜
        function switchTab(tabName) {
            // ëª¨ë“  íƒ­ ë¹„í™œì„±í™”
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            
            // ì„ íƒëœ íƒ­ í™œì„±í™”
            const tabButton = document.querySelector(`[onclick="switchTab('${tabName}')"]`);
            if (tabButton) tabButton.classList.add('active');
            
            const tabContent = document.getElementById(`${tabName}-tab`);
            if (tabContent) tabContent.classList.add('active');
            
            // íƒ­ë³„ ë°ì´í„° ë¡œë“œ
            switch(tabName) {
                case 'users':
                    loadUsers();
                    break;
                case 'analytics':
                    loadAnalytics();
                    break;
                case 'logs':
                    loadLogs();
                    break;
                case 'maintenance':
                    checkSystemHealth();
                    break;
            }
        }
        
        // ëŒ€ì‹œë³´ë“œ í†µê³„ ë¡œë“œ
        async function loadDashboardStats() {
            try {
                const response = await fetch(`${API_BASE}/admin/dashboard/stats`, {
                    headers: getApiHeaders()
                });
                
                if (!response.ok) {
                    throw new Error('í†µê³„ ë¡œë“œ ì‹¤íŒ¨');
                }
                
                const data = await response.json();
                
                document.getElementById('total-users').textContent = data.total_users || 0;
                document.getElementById('total-sessions').textContent = data.total_sessions || 0;
                document.getElementById('month-sessions').textContent = data.this_month_sessions || 0;
                document.getElementById('pending-sessions').textContent = data.pending_sessions || 0;
                
                const activeUsersInfo = document.getElementById('active-users-info');
                const completionRate = document.getElementById('completion-rate');
                const monthCompleted = document.getElementById('month-completed');
                const expiredSessionsInfo = document.getElementById('expired-sessions-info');
                
                if (activeUsersInfo) activeUsersInfo.textContent = `í™œì„± ì‚¬ìš©ì: ${data.active_users || 0}ëª…`;
                if (completionRate) completionRate.textContent = `ì™„ë£Œìœ¨: ${data.completion_rate || 0}%`;
                if (monthCompleted) monthCompleted.textContent = `ì™„ë£Œ: ${data.this_month_completed || 0}ê±´`;
                if (expiredSessionsInfo) expiredSessionsInfo.textContent = `ë§Œë£Œ: ${data.expired_sessions || 0}ê±´`;
                
            } catch (error) {
                console.error('í†µê³„ ë¡œë“œ ì˜¤ë¥˜:', error);
            }
        }
        
        // ì›”ë³„ ì°¨íŠ¸ ë¡œë“œ
        async function loadMonthlyChart() {
            try {
                const response = await fetch(`${API_BASE}/admin/usage-stats?months=12`, {
                    headers: getApiHeaders()
                });
                
                if (!response.ok) {
                    throw new Error('ì›”ë³„ í†µê³„ ë¡œë“œ ì‹¤íŒ¨');
                }
                
                const data = await response.json();
                
                const ctx = document.getElementById('monthlyChart').getContext('2d');
                
                if (monthlyChart) {
                    monthlyChart.destroy();
                }
                
                monthlyChart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: data.monthly_stats.map(stat => stat.month_name),
                        datasets: [{
                            label: 'ì´ ê²€ì‚¬ ìˆ˜',
                            data: data.monthly_stats.map(stat => stat.total_sessions),
                            backgroundColor: 'rgba(66, 153, 225, 0.8)',
                            borderColor: 'rgba(66, 153, 225, 1)',
                            borderWidth: 1
                        }, {
                            label: 'ì™„ë£Œëœ ê²€ì‚¬',
                            data: data.monthly_stats.map(stat => stat.completed_sessions),
                            backgroundColor: 'rgba(56, 161, 105, 0.8)',
                            borderColor: 'rgba(56, 161, 105, 1)',
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            title: {
                                display: true,
                                text: 'ì›”ë³„ ê²€ì‚¬ ì‹¤í–‰ í˜„í™©'
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    stepSize: 1
                                }
                            }
                        }
                    }
                });
                
            } catch (error) {
                console.error('ì›”ë³„ ì°¨íŠ¸ ë¡œë“œ ì˜¤ë¥˜:', error);
            }
        }
        
        // ì‚¬ìš©ì ëª©ë¡ ë¡œë“œ
        async function loadUsers(page = 1, search = '') {
            const usersLoading = document.getElementById('users-loading');
            const usersTable = document.getElementById('users-table');
            const usersPagination = document.getElementById('users-pagination');
            
            if (usersLoading) usersLoading.style.display = 'block';
            if (usersTable) usersTable.style.display = 'none';
            if (usersPagination) usersPagination.style.display = 'none';
            
            try {
                const url = new URL(`${API_BASE}/admin/users`);
                url.searchParams.append('page', page);
                url.searchParams.append('limit', 10);
                if (search) url.searchParams.append('search', search);
                
                const response = await fetch(url, {
                    headers: getApiHeaders()
                });
                
                if (!response.ok) {
                    throw new Error('ì‚¬ìš©ì ëª©ë¡ ë¡œë“œ ì‹¤íŒ¨');
                }
                
                const data = await response.json();
                
                currentUsersPage = data.pagination.current_page;
                totalUsersPages = data.pagination.total_pages;
                
                renderUserStatsSummary(data.users);
                renderUsersTable(data.users);
                renderUsersPagination();
                
                if (usersLoading) usersLoading.style.display = 'none';
                if (usersTable) usersTable.style.display = 'table';
                if (usersPagination) usersPagination.style.display = 'flex';
                
            } catch (error) {
                console.error('ì‚¬ìš©ì ëª©ë¡ ë¡œë“œ ì˜¤ë¥˜:', error);
                if (usersLoading) usersLoading.style.display = 'none';
            }
        }
        
        // ì‚¬ìš©ì í…Œì´ë¸” ë Œë”ë§
        function renderUsersTable(users) {
            const tbody = document.getElementById('user-table-body');
            if (!tbody) return;
            
            tbody.innerHTML = '';
            renderUserStatsSummary(users);
            
            // ì›”ë³„ í†µê³„ ì¹´ë“œ í‘œì‹œ
            const userMonthlyUsage = document.getElementById('user-monthly-usage');
            if (users.length === 1) {
                showUserMonthlyUsage(users[0].doctor_id, users[0].name);
            } else if (userMonthlyUsage) {
                userMonthlyUsage.innerHTML = '';
            }
            
            users.forEach(user => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td style="padding:8px 10px;">${user.name}</td>
                    <td style="padding:8px 10px;">${user.doctor_id}</td>
                    <td style="padding:8px 10px;">${user.email}</td>
                    <td style="padding:8px 10px;">${user.is_verified ? 'ì¸ì¦' : 'ë¯¸ì¸ì¦'}</td>
                    <td style="padding:8px 10px;">${user.is_active ? 'í™œì„±' : 'ë¹„í™œì„±'}</td>
                    <td style="padding:8px 10px;"><button style="padding:6px 12px;border-radius:6px;background:#4299e1;color:#fff;border:none;cursor:pointer;" onclick="showUserMonthlyUsageCard('${user.doctor_id}','${user.name.replace(/'/g, '\'')}')">í†µê³„ ë³´ê¸°</button></td>
                    <td style="padding:8px 10px; text-align:center;">
                        <label class="status-toggle">
                            <input type="checkbox" ${user.is_verified ? 'checked' : ''} onchange="toggleUserStatus('${user.doctor_id}', this.checked)">
                            <span class="slider"></span>
                        </label>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }
        
        // ì‚¬ìš©ì í˜ì´ì§• ë Œë”ë§
        function renderUsersPagination() {
            const pageNumbers = document.getElementById('users-page-numbers');
            if (!pageNumbers) return;
            
            pageNumbers.innerHTML = '';
            
            const firstPage = document.getElementById('users-first-page');
            const prevPage = document.getElementById('users-prev-page');
            const nextPage = document.getElementById('users-next-page');
            const lastPage = document.getElementById('users-last-page');
            
            if (firstPage) firstPage.disabled = currentUsersPage === 1;
            if (prevPage) prevPage.disabled = currentUsersPage === 1;
            if (nextPage) nextPage.disabled = currentUsersPage === totalUsersPages;
            if (lastPage) lastPage.disabled = currentUsersPage === totalUsersPages;
            
            const maxVisible = 5;
            let start = Math.max(1, currentUsersPage - Math.floor(maxVisible / 2));
            let end = Math.min(totalUsersPages, start + maxVisible - 1);
            
            if (end - start + 1 < maxVisible) {
                start = Math.max(1, end - maxVisible + 1);
            }
            
            for (let i = start; i <= end; i++) {
                const button = document.createElement('button');
                button.textContent = i;
                button.onclick = () => goToUsersPage(i);
                if (i === currentUsersPage) {
                    button.classList.add('active');
                }
                pageNumbers.appendChild(button);
            }
        }
        
        // ì‚¬ìš©ì í˜ì´ì§€ ì´ë™
        function goToUsersPage(page) {
            if (page < 1 || page > totalUsersPages) return;
            const searchInput = document.getElementById('user-search');
            const search = searchInput ? searchInput.value : '';
            loadUsers(page, search);
        }
        
        // ì‚¬ìš©ì ê²€ìƒ‰
        function searchUsers() {
            const searchInput = document.getElementById('user-search');
            const search = searchInput ? searchInput.value : '';
            loadUsers(1, search);
        }
        
        // ì‚¬ìš©ì ìƒˆë¡œê³ ì¹¨
        function refreshUsers() {
            const searchInput = document.getElementById('user-search');
            const search = searchInput ? searchInput.value : '';
            loadUsers(currentUsersPage, search);
        }
        
        // ì‚¬ìš©ì ìƒíƒœ í† ê¸€
        async function toggleUserStatus(doctorId, isVerified) {
            try {
                const response = await fetch(`${API_BASE}/admin/users/${doctorId}/status`, {
                    method: 'PATCH',
                    headers: {
                        ...getApiHeaders(),
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        is_verified: isVerified,
                        is_active: isVerified
                    })
                });

                if (!response.ok) {
                    throw new Error('ìƒíƒœ ë³€ê²½ ì‹¤íŒ¨');
                }

                const result = await response.json();
                showAlert(result.message, 'success');
                
                // ì‚¬ìš©ì ëª©ë¡ ìƒˆë¡œê³ ì¹¨
                loadUsers();
                
            } catch (error) {
                console.error('ìƒíƒœ ë³€ê²½ ì˜¤ë¥˜:', error);
                showAlert('ìƒíƒœ ë³€ê²½ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
                // ì²´í¬ë°•ìŠ¤ ìƒíƒœ ë³µì›ì„ ìœ„í•´ ëª©ë¡ ìƒˆë¡œê³ ì¹¨
                loadUsers();
            }
        }
        
        // ì‚¬ìš©ì í†µê³„ ìš”ì•½ ë Œë”ë§
        function renderUserStatsSummary(users) {
            const summaryElement = document.getElementById('user-stats-summary');
            if (!summaryElement || !users || users.length === 0) {
                if (summaryElement) summaryElement.innerHTML = '';
                return;
            }
            
            // Top 3 ê²€ì‚¬ìˆ˜
            const topTotal = [...users].sort((a, b) => (b.total_sessions || 0) - (a.total_sessions || 0)).slice(0, 3);
            // Top 3 ì™„ë£Œìœ¨ (ì™„ë£Œìœ¨ 0~100, ê²€ì‚¬ìˆ˜ 5ê±´ ì´ìƒë§Œ)
            const topCompletion = [...users]
                .filter(u => (u.total_sessions || 0) >= 5)
                .sort((a, b) => ((b.completed_sessions || 0) / (b.total_sessions || 1)) - ((a.completed_sessions || 0) / (a.total_sessions || 1)))
                .slice(0, 3);
            // Top 3 ìµœê·¼ 30ì¼ ê²€ì‚¬ìˆ˜
            const topRecent = [...users].sort((a, b) => (b.recent_30days_sessions || 0) - (a.recent_30days_sessions || 0)).slice(0, 3);
            
            function userCard(title, arr, valueFn, unit) {
                return `<div style="background:#f7fafc;border-radius:10px;padding:16px 18px;box-shadow:0 2px 8px rgba(0,0,0,0.04);min-width:220px;flex:1 1 220px;margin:0 8px 8px 0;">
                    <div style="font-weight:600;color:#2b6cb0;margin-bottom:8px;">${title}</div>
                    ${arr.map((u,i)=>`<div style='margin-bottom:4px;'><span style='font-weight:600;color:#222;'>${i+1}. ${u.name}</span> <span style='color:#888;font-size:0.95em;'>(${u.doctor_id})</span> <span style='color:#4299e1;font-weight:600;'>${valueFn(u)}${unit}</span></div>`).join('')}
                </div>`;
            }
            const html = `<div style="display:flex;flex-wrap:wrap;gap:12px;margin-bottom:18px;">
                ${userCard('ê²€ì‚¬ìˆ˜ Top 3', topTotal, u=>u.total_sessions||0, 'ê±´')}
                ${userCard('ì™„ë£Œìœ¨ Top 3 (5ê±´â†‘)', topCompletion, u=>u.total_sessions?Math.round((u.completed_sessions||0)/(u.total_sessions||1)*100):0, '%')}
                ${userCard('ìµœê·¼ 30ì¼ ê²€ì‚¬ìˆ˜ Top 3', topRecent, u=>u.recent_30days_sessions||0, 'ê±´')}
            </div>`;
            summaryElement.innerHTML = html;
        }
        
        // ë¶„ì„ ë°ì´í„° ë¡œë“œ
        async function loadAnalytics() {
            const analyticsLoading = document.getElementById('analytics-loading');
            const analyticsContent = document.getElementById('analytics-content');
            
            if (analyticsLoading) analyticsLoading.style.display = 'block';
            if (analyticsContent) analyticsContent.style.display = 'none';
            
            try {
                const response = await fetch(`${API_BASE}/admin/usage-stats?months=6`, {
                    headers: getApiHeaders()
                });
                
                if (!response.ok) {
                    throw new Error('ë¶„ì„ ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨');
                }
                
                const data = await response.json();
                
                // ì‚¬ìš©ë¥  ì°¨íŠ¸ ìƒì„±
                const usageChartCanvas = document.getElementById('usageChart');
                if (usageChartCanvas) {
                    const ctx = usageChartCanvas.getContext('2d');
                    
                    if (usageChart) {
                        usageChart.destroy();
                    }
                    
                    usageChart = new Chart(ctx, {
                        type: 'line',
                        data: {
                            labels: data.monthly_stats.map(stat => stat.month_name),
                            datasets: [{
                                label: 'í™œì„± ì‚¬ìš©ì',
                                data: data.monthly_stats.map(stat => stat.active_users),
                                borderColor: 'rgba(66, 153, 225, 1)',
                                backgroundColor: 'rgba(66, 153, 225, 0.1)',
                                tension: 0.4
                            }, {
                                label: 'ì™„ë£Œìœ¨ (%)',
                                data: data.monthly_stats.map(stat => stat.completion_rate),
                                borderColor: 'rgba(56, 161, 105, 1)',
                                backgroundColor: 'rgba(56, 161, 105, 0.1)',
                                tension: 0.4,
                                yAxisID: 'y1'
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                title: {
                                    display: true,
                                    text: 'ì‹œìŠ¤í…œ ì‚¬ìš©ë¥  ë¶„ì„'
                                }
                            },
                            scales: {
                                y: {
                                    type: 'linear',
                                    display: true,
                                    position: 'left',
                                },
                                y1: {
                                    type: 'linear',
                                    display: true,
                                    position: 'right',
                                    grid: {
                                        drawOnChartArea: false,
                                    },
                                }
                            }
                        }
                    });
                }
                
                // ìš”ì•½ ì •ë³´ ìƒì„±
                const summaryHtml = `
                    <h3>ğŸ“Š ë¶„ì„ ìš”ì•½</h3>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-top: 15px;">
                        <div style="background: #f7fafc; padding: 15px; border-radius: 8px;">
                            <div style="font-weight: bold; color: #2d3748;">í‰ê·  ì™„ë£Œìœ¨</div>
                            <div style="font-size: 1.5em; color: #4299e1;">${(data.monthly_stats.reduce((acc, stat) => acc + stat.completion_rate, 0) / data.monthly_stats.length).toFixed(1)}%</div>
                        </div>
                        <div style="background: #f7fafc; padding: 15px; border-radius: 8px;">
                            <div style="font-weight: bold; color: #2d3748;">ì›”í‰ê·  ê²€ì‚¬ ìˆ˜</div>
                            <div style="font-size: 1.5em; color: #38a169;">${Math.round(data.monthly_stats.reduce((acc, stat) => acc + stat.total_sessions, 0) / data.monthly_stats.length)}ê±´</div>
                        </div>
                    </div>
                `;
                
                const analyticsSummary = document.getElementById('analytics-summary');
                if (analyticsSummary) {
                    analyticsSummary.innerHTML = summaryHtml;
                }
                
                if (analyticsLoading) analyticsLoading.style.display = 'none';
                if (analyticsContent) analyticsContent.style.display = 'block';
                
            } catch (error) {
                console.error('ë¶„ì„ ë°ì´í„° ë¡œë“œ ì˜¤ë¥˜:', error);
                if (analyticsLoading) analyticsLoading.style.display = 'none';
            }
        }
        
        // ë¡œê·¸ ë¡œë“œ
        async function loadLogs(page = 1) {
            const logsLoading = document.getElementById('logs-loading');
            if (logsLoading) logsLoading.style.display = 'block';
            
            try {
                const levelFilter = document.getElementById('log-level-filter');
                const level = levelFilter ? levelFilter.value : '';
                
                const url = new URL(`${API_BASE}/admin/system-logs`);
                url.searchParams.append('page', page);
                url.searchParams.append('limit', 20);
                if (level) url.searchParams.append('level', level);
                
                const response = await fetch(url, {
                    headers: getApiHeaders()
                });
                
                if (!response.ok) {
                    throw new Error('ë¡œê·¸ ë¡œë“œ ì‹¤íŒ¨');
                }
                
                const data = await response.json();
                
                currentLogsPage = data.pagination.current_page;
                totalLogsPages = data.pagination.total_pages;
                
                renderLogs(data.logs);
                renderLogsPagination();
                
                if (logsLoading) logsLoading.style.display = 'none';
                
            } catch (error) {
                console.error('ë¡œê·¸ ë¡œë“œ ì˜¤ë¥˜:', error);
                if (logsLoading) logsLoading.style.display = 'none';
            }
        }
        
        // ë¡œê·¸ ë Œë”ë§
        function renderLogs(logs) {
            const container = document.getElementById('logs-container');
            if (!container) return;
            
            container.innerHTML = '';
            
            if (logs.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #718096; padding: 40px;">ë¡œê·¸ê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
                return;
            }
            
            logs.forEach(log => {
                const logEntry = document.createElement('div');
                logEntry.className = 'log-entry';
                
                const timestamp = log.timestamp ? 
                    new Date(log.timestamp).toLocaleString('ko-KR') : '-';
                
                logEntry.innerHTML = `
                    <div class="log-timestamp">${timestamp}</div>
                    <div class="log-message">${log.message}</div>
                    ${log.details ? `<div class="log-details">ì„¸ë¶€ì‚¬í•­: ${JSON.stringify(log.details)}</div>` : ''}
                `;
                
                container.appendChild(logEntry);
            });
        }
        
        // ë¡œê·¸ í˜ì´ì§• ë Œë”ë§
        function renderLogsPagination() {
            const logsPagination = document.getElementById('logs-pagination');
            if (!logsPagination) return;
            
            if (totalLogsPages <= 1) {
                logsPagination.style.display = 'none';
                return;
            }
            
            logsPagination.style.display = 'flex';
            
            const pageNumbers = document.getElementById('logs-page-numbers');
            if (pageNumbers) {
                pageNumbers.innerHTML = '';
                
                const logsFirstPage = document.getElementById('logs-first-page');
                const logsPrevPage = document.getElementById('logs-prev-page');
                const logsNextPage = document.getElementById('logs-next-page');
                const logsLastPage = document.getElementById('logs-last-page');
                
                if (logsFirstPage) logsFirstPage.disabled = currentLogsPage === 1;
                if (logsPrevPage) logsPrevPage.disabled = currentLogsPage === 1;
                if (logsNextPage) logsNextPage.disabled = currentLogsPage === totalLogsPages;
                if (logsLastPage) logsLastPage.disabled = currentLogsPage === totalLogsPages;
                
                const maxVisible = 5;
                let start = Math.max(1, currentLogsPage - Math.floor(maxVisible / 2));
                let end = Math.min(totalLogsPages, start + maxVisible - 1);
                
                for (let i = start; i <= end; i++) {
                    const button = document.createElement('button');
                    button.textContent = i;
                    button.onclick = () => goToLogsPage(i);
                    if (i === currentLogsPage) {
                        button.classList.add('active');
                    }
                    pageNumbers.appendChild(button);
                }
            }
        }
        
        // ë¡œê·¸ í˜ì´ì§€ ì´ë™
        function goToLogsPage(page) {
            if (page < 1 || page > totalLogsPages) return;
            loadLogs(page);
        }
        
        // ë¡œê·¸ ìƒˆë¡œê³ ì¹¨
        function refreshLogs() {
            loadLogs(1);
        }
        
        // ì‹œìŠ¤í…œ ìƒíƒœ í™•ì¸
        async function checkSystemHealth() {
            try {
                const response = await fetch(`${API_BASE}/health`);
                const data = await response.json();
                
                const statusHtml = `
                    <p>âœ… ë°ì´í„°ë² ì´ìŠ¤: ${data.database.status === 'healthy' ? 'ì •ìƒ' : 'ì˜¤ë¥˜'}</p>
                    <p>âœ… OpenAI API: ${data.openai === 'available' ? 'ì •ìƒ' : 'ë¹„í™œì„±'}</p>
                    <p>âœ… ì„œë²„ ì‹œê°„: ${new Date(data.timestamp).toLocaleString('ko-KR')}</p>
                `;
                
                const systemStatus = document.getElementById('system-status');
                if (systemStatus) {
                    systemStatus.innerHTML = statusHtml;
                }
                
            } catch (error) {
                console.error('ì‹œìŠ¤í…œ ìƒíƒœ í™•ì¸ ì˜¤ë¥˜:', error);
                const systemStatus = document.getElementById('system-status');
                if (systemStatus) {
                    systemStatus.innerHTML = '<p>âŒ ì‹œìŠ¤í…œ ìƒíƒœ í™•ì¸ ì‹¤íŒ¨</p>';
                }
            }
        }
        
        // ì •ë¦¬ ì‹œë®¬ë ˆì´ì…˜
        async function simulateCleanup() {
            const cleanupDays = document.getElementById('cleanup-days');
            const days = cleanupDays ? cleanupDays.value : 30;
            
            try {
                const response = await fetch(`${API_BASE}/admin/cleanup?days_old=${days}&dry_run=true`, {
                    method: 'POST',
                    headers: getApiHeaders()
                });
                
                if (!response.ok) {
                    throw new Error('ì‹œë®¬ë ˆì´ì…˜ ì‹¤íŒ¨');
                }
                
                const data = await response.json();
                
                const resultHtml = `
                    <div style="background: #e6fffa; padding: 15px; border-radius: 8px; border-left: 4px solid #38b2ac;">
                        <h4>ğŸ§ª ì‹œë®¬ë ˆì´ì…˜ ê²°ê³¼</h4>
                        <p><strong>ì •ë¦¬ ëŒ€ìƒ:</strong> ${days}ì¼ ì´ì „ ë§Œë£Œëœ ì„¸ì…˜</p>
                        <p><strong>ì‚­ì œë  ì„¸ì…˜ ìˆ˜:</strong> ${data.sessions_to_cleanup}ê°œ</p>
                        <p><strong>ì‚­ì œë  ì´ ë°ì´í„°:</strong></p>
                        <ul>
                            <li>ì‘ë‹µ ë°ì´í„°: ${data.cleanup_details.reduce((acc, item) => acc + (item.responses_to_delete || 0), 0)}ê°œ</li>
                            <li>í•´ì„ ê²°ê³¼: ${data.cleanup_details.reduce((acc, item) => acc + (item.interpretations_to_delete || 0), 0)}ê°œ</li>
                        </ul>
                        <p style="margin-top: 10px;"><em>â€» ì´ê²ƒì€ ì‹œë®¬ë ˆì´ì…˜ì´ë©° ì‹¤ì œ ë°ì´í„°ëŠ” ì‚­ì œë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.</em></p>
                    </div>
                `;
                
                const cleanupResult = document.getElementById('cleanup-result');
                if (cleanupResult) {
                    cleanupResult.innerHTML = resultHtml;
                }
                
                // í†µê³„ ìƒˆë¡œê³ ì¹¨
                loadDashboardStats();
                
            } catch (error) {
                console.error('ì •ë¦¬ ì‹¤í–‰ ì˜¤ë¥˜:', error);
                const cleanupResult = document.getElementById('cleanup-result');
                if (cleanupResult) {
                    cleanupResult.innerHTML = '<div style="background: #fed7d7; padding: 15px; border-radius: 8px;">âŒ ì •ë¦¬ ì‹¤í–‰ ì‹¤íŒ¨</div>';
                }
            }
        }
        
        // ì •ë¦¬ ì‹¤í–‰
        async function executeCleanup() {
            const cleanupDays = document.getElementById('cleanup-days');
            const days = cleanupDays ? cleanupDays.value : 30;
            
            if (!confirm(`ì •ë§ë¡œ ${days}ì¼ ì´ì „ì˜ ë§Œë£Œëœ ë°ì´í„°ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\nì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.`)) {
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE}/admin/cleanup?days_old=${days}&dry_run=false`, {
                    method: 'POST',
                    headers: getApiHeaders()
                });
                
                if (!response.ok) {
                    throw new Error('ì •ë¦¬ ì‹¤í–‰ ì‹¤íŒ¨');
                }
                
                const data = await response.json();
                
                const resultHtml = `
                    <div style="background: #c6f6d5; padding: 15px; border-radius: 8px; border-left: 4px solid #38a169;">
                        <h4>âœ… ì •ë¦¬ ì™„ë£Œ</h4>
                        <p><strong>ì‚­ì œëœ ì„¸ì…˜ ìˆ˜:</strong> ${data.actual_cleaned}ê°œ</p>
                        <p><strong>ì •ë¦¬ ì™„ë£Œ ì‹œê°„:</strong> ${new Date().toLocaleString('ko-KR')}</p>
                    </div>
                `;
                
                const cleanupResult = document.getElementById('cleanup-result');
                if (cleanupResult) {
                    cleanupResult.innerHTML = resultHtml;
                }
                
            } catch (error) {
                console.error('ì •ë¦¬ ì‹¤í–‰ ì˜¤ë¥˜:', error);
                const cleanupResult = document.getElementById('cleanup-result');
                if (cleanupResult) {
                    cleanupResult.innerHTML = '<div style="background: #fed7d7; padding: 15px; border-radius: 8px;">âŒ ì •ë¦¬ ì‹¤í–‰ ì‹¤íŒ¨</div>';
                }
            }
        }
        
        // ì›”ë³„ í†µê³„ ì¹´ë“œ í•¨ìˆ˜ ì¶”ê°€
        async function showUserMonthlyUsage(doctorId, name) {
            try {
                console.log(`ğŸ“¡ API ìš”ì²­: /admin/usage-stats?doctor_id=${doctorId}&months=12`);
                const response = await fetch(`${API_BASE}/admin/usage-stats?doctor_id=${doctorId}&months=12`, {
                    headers: getApiHeaders()
                });
                console.log('API ì‘ë‹µ ìƒíƒœ:', response.status, response.statusText);
                if (!response.ok) throw new Error('ì›”ë³„ í†µê³„ ë¡œë“œ ì‹¤íŒ¨');
                const data = await response.json();

                // Ensure data points are numbers and find the maximum
                const allSessionValues = data.monthly_stats.flatMap(stat => [
                    Number(stat.total_sessions || 0),
                    Number(stat.completed_sessions || 0)
                ]);
                const maxDataValue = allSessionValues.length > 0 ? Math.max(...allSessionValues) : 0;

                // ì°¨íŠ¸ ì»¨í…Œì´ë„ˆ ìƒì„±
                const container = document.createElement('div');
                container.style.margin = '18px 0 24px 0';
                container.style.padding = '18px 20px';
                container.style.background = '#f7fafc';
                container.style.borderRadius = '10px';
                container.style.boxShadow = '0 2px 8px rgba(0,0,0,0.04)';
                container.style.height = '350px'; // ì»¨í…Œì´ë„ˆì— ê³ ì • ë†’ì´ ì¶”ê°€
                container.style.overflow = 'hidden'; // ì¶”ê°€: ì»¨í…Œì´ë„ˆì˜ ë‚´ìš©ì„ ë²—ì–´ë‚˜ì§€ ì•Šë„ë¡
                container.innerHTML = `<strong style="font-size: 1.1em;">ğŸ‘¤ ${name} (${doctorId}) ì›”ë³„ ê²€ì‚¬ í†µê³„</strong>`;
                
                // ìº”ë²„ìŠ¤ ì´ˆê¸°í™” ë° ìƒˆë¡œ ìƒì„± (ê°•í™”ëœ ì´ˆê¸°í™”)
                let canvas = document.getElementById('user-monthly-chart-canvas');
                if (canvas) {
                    canvas.remove();
                }
                canvas = document.createElement('canvas');
                canvas.id = 'user-monthly-chart-canvas'; // ìƒˆë¡œìš´ ID ë¶€ì—¬
                canvas.style.marginTop = '15px';
                container.appendChild(canvas);

                const userDetailStats = document.getElementById('user-detail-stats');
                if (userDetailStats) {
                    userDetailStats.innerHTML = '';
                    userDetailStats.appendChild(container);
                }
                
                if (window.userMonthlyChart) {
                    window.userMonthlyChart.destroy();
                }

                // Yì¶• ì„¤ì • ê°’ ë¡œê·¸ (ë””ë²„ê¹…)
                console.log('ğŸ“Š Chart Y-axis Config:', { max: 10, stepSize: 1 });

                window.userMonthlyChart = new Chart(canvas.getContext('2d'), {
                    type: 'bar',
                    data: {
                        labels: data.monthly_stats.map(stat => stat.month_name),
                        datasets: [{
                            label: 'ì´ ê²€ì‚¬ ìˆ˜',
                            data: data.monthly_stats.map(stat => Number(stat.total_sessions) || 0),
                            backgroundColor: 'rgba(66, 153, 225, 0.8)',
                            borderColor: 'rgba(66, 153, 225, 1)',
                            borderWidth: 1,
                            minBarLength: 20 // ìµœì†Œ ë§‰ëŒ€ ê¸¸ì´ ì„¤ì •
                        }, {
                            label: 'ì™„ë£Œëœ ê²€ì‚¬',
                            data: data.monthly_stats.map(stat => Number(stat.completed_sessions) || 0),
                            backgroundColor: 'rgba(56, 161, 105, 0.8)',
                            borderColor: 'rgba(56, 161, 105, 1)',
                            borderWidth: 1,
                            minBarLength: 20 // ìµœì†Œ ë§‰ëŒ€ ê¸¸ì´ ì„¤ì •
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            title: {
                                display: true,
                                text: 'ì›”ë³„ ê²€ì‚¬ í˜„í™©'
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        const label = context.dataset.label || '';
                                        const value = context.raw;
                                        return `${label}: ${value}ê±´`;
                                    }
                                }
                            }
                        },
                        scales: {
                            y: {
                                min: 0, // Explicitly set min to 0
                                beginAtZero: true,
                                max: 10, // Explicitly set max to 10 for consistent small-value scaling
                                ticks: {
                                    stepSize: 1 // Explicitly set stepSize to 1
                                },
                                title: {
                                    display: true,
                                    text: 'ê²€ì‚¬ ìˆ˜'
                                }
                            }
                        }
                    }
                });
                // ìš”ì•½ ì •ë³´ ì¶”ê°€ (ë³µêµ¬)
                const summary = document.createElement('div');
                summary.style.marginTop = '15px';
                summary.style.display = 'flex';
                summary.style.gap = '15px';
                summary.style.flexWrap = 'wrap';
                const totalSessions = data.monthly_stats.reduce((sum, stat) => sum + stat.total_sessions, 0);
                const totalCompleted = data.monthly_stats.reduce((sum, stat) => sum + stat.completed_sessions, 0);
                const avgCompletionRate = Math.round((totalCompleted / totalSessions * 100) || 0);
                summary.innerHTML = `
                    <div style="background: white; padding: 12px; border-radius: 8px; flex: 1; min-width: 150px;">
                        <div style="font-size: 0.9em; color: #666;">ì´ ê²€ì‚¬ ìˆ˜</div>
                        <div style="font-size: 1.5em; font-weight: bold; color: #4299e1;">${totalSessions}ê±´</div>
                    </div>
                    <div style="background: white; padding: 12px; border-radius: 8px; flex: 1; min-width: 150px;">
                        <div style="font-size: 0.9em; color: #666;">ì™„ë£Œëœ ê²€ì‚¬</div>
                        <div style="font-size: 1.5em; font-weight: bold; color: #38a169;">${totalCompleted}ê±´</div>
                    </div>
                    <div style="background: white; padding: 12px; border-radius: 8px; flex: 1; min-width: 150px;">
                        <div style="font-size: 0.9em; color: #666;">í‰ê·  ì™„ë£Œìœ¨</div>
                        <div style="font-size: 1.5em; font-weight: bold; color: #805ad5;">${avgCompletionRate}%</div>
                    </div>
                `;
                container.appendChild(summary);
            } catch (e) {
                console.error('ì›”ë³„ í†µê³„ ë¡œë“œ ì˜¤ë¥˜:', e);
                const userDetailStats = document.getElementById('user-detail-stats');
                if (userDetailStats) {
                    userDetailStats.innerHTML = '<div style="color: #e53e3e; padding: 15px; background: #fff5f5; border-radius: 8px;">ì›”ë³„ í†µê³„ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</div>';
                }
            }
        }

        async function loadAllUsersAndRenderTable() {
            try {
                const response = await fetch(`${API_BASE}/admin/users?limit=1000`, { headers: getApiHeaders() });
                if (!response.ok) throw new Error('ì´ìš©ì ëª©ë¡ ë¡œë“œ ì‹¤íŒ¨');
                const data = await response.json();
                const users = data.users;
                const tbody = document.getElementById('user-table-body');
                if (!tbody) return;
                
                tbody.innerHTML = '';
                users.forEach(user => {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td style="padding:8px 10px;">${user.name}</td>
                        <td style="padding:8px 10px;">${user.doctor_id}</td>
                        <td style="padding:8px 10px;">${user.email}</td>
                        <td style="padding:8px 10px;">${user.is_verified ? 'ì¸ì¦' : 'ë¯¸ì¸ì¦'}</td>
                        <td style="padding:8px 10px;">${user.is_active ? 'í™œì„±' : 'ë¹„í™œì„±'}</td>
                        <td style="padding:8px 10px;"><button style="padding:6px 12px;border-radius:6px;background:#4299e1;color:#fff;border:none;cursor:pointer;" onclick="showUserMonthlyUsageCard('${user.doctor_id}','${user.name.replace(/'/g, '\'')}')">í†µê³„ ë³´ê¸°</button></td>
                        <td style="padding:8px 10px; text-align:center;">
                            <label class="status-toggle">
                                <input type="checkbox" ${user.is_verified ? 'checked' : ''} onchange="toggleUserStatus('${user.doctor_id}', this.checked)">
                                <span class="slider"></span>
                            </label>
                        </td>
                    `;
                    tbody.appendChild(tr);
                });
            } catch (e) {
                const tbody = document.getElementById('user-table-body');
                if (tbody) {
                    tbody.innerHTML = '<tr><td colspan="7" style="color:#e53e3e;">ì´ìš©ì ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</td></tr>';
                }
            }
        }

        async function showUserMonthlyUsageCard(doctorId, name) {
            console.log(`âœ… í†µê³„ ë³´ê¸° ë²„íŠ¼ í´ë¦­: ${name} (${doctorId})`);
            const userDetailStats = document.getElementById('user-detail-stats');
            if (userDetailStats) {
                userDetailStats.innerHTML = '<div style="padding:20px;">ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>';
            }
            await showUserMonthlyUsage(doctorId, name);
        }

        // GPT ì‚¬ìš©ëŸ‰ ë¡œë“œ
        async function loadGPTUsage() {
            try {
                const startDateInput = document.getElementById('gpt-start-date');
                const endDateInput = document.getElementById('gpt-end-date');
                
                if (!startDateInput || !endDateInput) {
                    console.log('GPT ì‚¬ìš©ëŸ‰ ì…ë ¥ ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                    return;
                }
                
                const startDate = startDateInput.value;
                const endDate = endDateInput.value;
                
                const response = await fetch(`${API_BASE}/admin/gpt-usage?start_date=${startDate}&end_date=${endDate}`, {
                    headers: getApiHeaders()
                });
                
                if (!response.ok) {
                    throw new Error('GPT ì‚¬ìš©ëŸ‰ ì¡°íšŒ ì‹¤íŒ¨');
                }
                
                const data = await response.json();
                
                // ì´ê³„ ì—…ë°ì´íŠ¸
                const totalTokens = document.getElementById('total-tokens');
                const totalCost = document.getElementById('total-cost');
                
                if (totalTokens) totalTokens.textContent = data.total_usage.total_tokens.toLocaleString();
                if (totalCost) totalCost.textContent = `${data.total_usage.total_cost.toFixed(2)}`;
                
                // ì˜ì‚¬ë³„ í†µê³„
                const doctorStats = document.getElementById('gpt-doctor-stats');
                if (doctorStats) {
                    doctorStats.innerHTML = data.doctor_stats.map(stat => `
                        <tr>
                            <td>${stat.doctor_id}</td>
                            <td>${stat.usage_count}</td>
                            <td>${stat.total_tokens.toLocaleString()}</td>
                            <td>${stat.total_cost.toFixed(2)}</td>
                        </tr>
                    `).join('');
                }
                
                // ëª¨ë¸ë³„ í†µê³„
                const modelStats = document.getElementById('gpt-model-stats');
                if (modelStats) {
                    modelStats.innerHTML = data.model_stats.map(stat => `
                        <tr>
                            <td>${stat.model}</td>
                            <td>${stat.usage_count}</td>
                            <td>${stat.total_tokens.toLocaleString()}</td>
                            <td>${stat.total_cost.toFixed(2)}</td>
                        </tr>
                    `).join('');
                }
                
            } catch (error) {
                console.error('GPT ì‚¬ìš©ëŸ‰ ì¡°íšŒ ì˜¤ë¥˜:', error);
                alert('GPT ì‚¬ìš©ëŸ‰ ì¡°íšŒ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            }
        }

        // ë³´ì•ˆ ëª¨ë‹ˆí„°ë§ ë°ì´í„° ë¡œë“œ (ìˆ˜ì •ëœ ë²„ì „)
        async function loadSecurityData() {
            try {
                // ë¡œê·¸ì¸ ì‹œë„ ê¸°ë¡ ë¡œë“œ
                const attemptsResponse = await fetch(`${API_BASE}/admin/login-attempts`, {
                    headers: getApiHeaders()
                });
                
                if (attemptsResponse.ok) {
                    const attempts = await attemptsResponse.json();
                    const attemptsTable = document.getElementById('loginAttemptsTable');
                    if (attemptsTable) {
                        attemptsTable.innerHTML = '';
                        
                        attempts.forEach(attempt => {
                            const row = document.createElement('tr');
                            row.innerHTML = `
                                <td>${new Date(attempt.attempt_time).toLocaleString()}</td>
                                <td>${attempt.ip_address}</td>
                                <td>${attempt.doctor_id}</td>
                                <td>
                                    <span class="badge ${attempt.success ? 'bg-success' : 'bg-danger'}">
                                        ${attempt.success ? 'ì„±ê³µ' : 'ì‹¤íŒ¨'}
                                    </span>
                                </td>
                                <td>${attempt.user_agent}</td>
                            `;
                            attemptsTable.appendChild(row);
                        });
                    }
                }
                
                // IP ì°¨ë‹¨ ëª©ë¡ ë¡œë“œ
                const blocksResponse = await fetch(`${API_BASE}/admin/ip-blocks`, {
                    headers: getApiHeaders()
                });
                
                if (blocksResponse.ok) {
                    const blocks = await blocksResponse.json();
                    const blocksTable = document.getElementById('ipBlocksTable');
                    if (blocksTable) {
                        blocksTable.innerHTML = '';
                        
                        blocks.forEach(block => {
                            const row = document.createElement('tr');
                            row.innerHTML = `
                                <td>${block.ip_address}</td>
                                <td>${block.attempts}</td>
                                <td>${new Date(block.last_attempt).toLocaleString()}</td>
                                <td>${new Date(block.blocked_until).toLocaleString()}</td>
                            `;
                            blocksTable.appendChild(row);
                        });
                    }
                }
            } catch (error) {
                console.error('ë³´ì•ˆ ë°ì´í„° ë¡œë“œ ì¤‘ ì˜¤ë¥˜:', error);
                console.log('ë³´ì•ˆ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            }
        }

        // ì‹œìŠ¤í…œ ì„¤ì • ë¡œë“œ (ìˆ˜ì •ëœ ë²„ì „)
        async function loadSystemSettings() {
            try {
                const response = await fetch(`${API_BASE}/admin/settings`, {
                    headers: getApiHeaders()
                });
                
                if (response.ok) {
                    const settings = await response.json();
                    const maxSessions = document.getElementById('maxConcurrentSessions');
                    const timeout = document.getElementById('sessionTimeout');
                    
                    if (maxSessions) maxSessions.value = settings.max_concurrent_sessions || 2;
                    if (timeout) timeout.value = settings.session_timeout_minutes || 30;
                }
            } catch (error) {
                console.error('ì‹œìŠ¤í…œ ì„¤ì • ë¡œë“œ ì¤‘ ì˜¤ë¥˜:', error);
                console.log('ì‹œìŠ¤í…œ ì„¤ì •ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            }
        }

        // ì‹œìŠ¤í…œ ì„¤ì • í¼ ì´ë²¤íŠ¸ ì„¤ì • (ìˆ˜ì •ëœ ë²„ì „)
        function setupSystemSettingsForm() {
            const systemForm = document.getElementById('systemSettingsForm');
            if (systemForm) {
                systemForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    
                    try {
                        const maxSessions = document.getElementById('maxConcurrentSessions');
                        const timeout = document.getElementById('sessionTimeout');
                        
                        const settings = {
                            max_concurrent_sessions: maxSessions ? maxSessions.value : 2,
                            session_timeout_minutes: timeout ? timeout.value : 30
                        };
                        
                        const response = await fetch(`${API_BASE}/admin/settings`, {
                            method: 'POST',
                            headers: getApiHeaders(),
                            body: JSON.stringify(settings)
                        });
                        
                        if (response.ok) {
                            alert('ì‹œìŠ¤í…œ ì„¤ì •ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.');
                        } else {
                            const error = await response.json();
                            alert(error.detail || 'ì‹œìŠ¤í…œ ì„¤ì • ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                        }
                    } catch (error) {
                        console.error('ì‹œìŠ¤í…œ ì„¤ì • ì €ì¥ ì¤‘ ì˜¤ë¥˜:', error);
                        alert('ì‹œìŠ¤í…œ ì„¤ì • ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                    }
                });
            }
        }

        function getToken() {
            return localStorage.getItem('access_token');
        }
        
        function showToast(message, type = 'info') {
            console.log(`[${type.toUpperCase()}] ${message}`);
        }

        // ì•Œë¦¼ ë©”ì‹œì§€ í‘œì‹œ í•¨ìˆ˜
        function showAlert(message, type = 'info') {
            // Toastify ë¼ì´ë¸ŒëŸ¬ë¦¬ ì‚¬ìš©
            Toastify({
                text: message,
                duration: 3000,
                gravity: "top",
                position: "center",
                backgroundColor: type === 'success' ? "#4CAF50" : 
                                type === 'error' ? "#F44336" : 
                                type === 'warning' ? "#FF9800" : "#2196F3",
                stopOnFocus: true
            }).showToast();
        }
    </script>
</body>
</html>